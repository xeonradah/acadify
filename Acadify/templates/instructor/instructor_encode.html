{% extends "common/base.html" %}

{% block title %}Grade Encoding - {{ subject.subject_code }} - Acadify{% endblock %}

{% block head %}
<style>
/* Hide number input spinners for all browsers */
.grade-input::-webkit-outer-spin-button,
.grade-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.grade-input[type=number] {
    -moz-appearance: textfield;
}

/* Enhanced table styling */
.grade-table {
    border-collapse: separate;
    border-spacing: 0;
}

.grade-table th {
    position: sticky;
    top: 0;
    z-index: 10;
}

.grade-table tbody tr:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.grade-input:focus {
    transform: scale(1.05);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

/* Responsive table improvements */
@media (max-width: 768px) {
    .grade-table th,
    .grade-table td {
        padding: 0.5rem 0.25rem;
        font-size: 0.875rem;
    }
    
    .grade-input {
        width: 4rem !important;
        font-size: 0.75rem;
    }
    
    .final-average,
    .equivalent-grade {
        font-size: 0.875rem !important;
        padding: 0.25rem 0.5rem !important;
    }
}

@media (max-width: 640px) {
    .grade-table th,
    .grade-table td {
        padding: 0.25rem 0.125rem;
        font-size: 0.75rem;
    }
    
    .grade-input {
        width: 3rem !important;
        font-size: 0.625rem;
    }
}

/* Animation for grade updates */
@keyframes gradeUpdate {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.grade-updated {
    animation: gradeUpdate 0.3s ease-in-out;
}

/* Enhanced focus states */
.grade-input:focus {
    outline: none;
    border-color: currentColor;
}

/* Better visual hierarchy */
.table-container {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.02) 0%, rgba(6, 182, 212, 0.02) 100%);
}
</style>
{% endblock %}

{% block content %}
<section class="fade-in min-h-screen">
    <div class="container max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Registrar Access Notice -->
        {% if is_registrar_access %}
        <div class="alert alert-info shadow-lg mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="16" x2="12" y2="12"/>
                <line x1="12" y1="8" x2="12.01" y2="8"/>
            </svg>
            <div class="flex-1">
                <h4 class="font-semibold text-lg">Registrar View Mode</h4>
                <p class="text-sm mt-1">You are viewing grades in read-only mode. You cannot edit or save grades. Only the Print Grades function is available.</p>
            </div>
        </div>
        {% endif %}

        <!-- Header -->
        <div class="mb-8">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
                <div class="flex items-start gap-4">
                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-indigo-500 to-cyan-600 flex items-center justify-center shadow-refined-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-base-content tracking-tight mb-2">
                            {% if is_registrar_access %}View Grades{% else %}Grade Encoding{% endif %}
                        </h1>
                        <div class="flex items-center gap-2 text-indigo-600 dark:text-indigo-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                            </svg>
                            <span class="font-semibold">{{ subject.subject_code }} - {{ subject.subject_name }}</span>
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-3">
                    <!-- Empty space where Save Changes button was -->
                </div>
            </div>
        </div>

        <!-- Grading Period Status -->
        {% if prelim_schedule or midterm_schedule or final_schedule %}
        <div class="bg-base-100 rounded-2xl border border-base-300/50 overflow-hidden shadow-sm mb-6">
            <div class="p-6">
                <h3 class="text-lg font-semibold text-base-content mb-4">Grading Period Status</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Prelim Status -->
                    <div class="flex items-center gap-3 p-4 rounded-xl {% if prelim_open %}bg-green-50 dark:bg-green-950/20 border border-green-200 dark:border-green-800{% else %}bg-base-200{% endif %}">
                        <div class="p-2 rounded-lg {% if prelim_open %}bg-green-500 text-white{% else %}bg-base-300 text-base-content/60{% endif %}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                        </div>
                        <div>
                            <p class="font-semibold text-base-content">Prelim</p>
                            <p class="text-sm text-base-content/60">
                                {% if prelim_open %}
                                    {% if schedule and schedule.grading_period == 'all' %}
                                        Open (All Periods)
                                    {% else %}
                                        Open until {{ prelim_schedule.end_date.strftime('%b %d, %Y') }}
                                    {% endif %}
                                {% elif prelim_schedule %}
                                    Closed
                                {% else %}
                                    No schedule
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    
                    <!-- Midterm Status -->
                    <div class="flex items-center gap-3 p-4 rounded-xl {% if midterm_open %}bg-green-50 dark:bg-green-950/20 border border-green-200 dark:border-green-800{% else %}bg-base-200{% endif %}">
                        <div class="p-2 rounded-lg {% if midterm_open %}bg-green-500 text-white{% else %}bg-base-300 text-base-content/60{% endif %}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                        </div>
                        <div>
                            <p class="font-semibold text-base-content">Midterm</p>
                            <p class="text-sm text-base-content/60">
                                {% if midterm_open %}
                                    {% if schedule and schedule.grading_period == 'all' %}
                                        Open (All Periods)
                                    {% else %}
                                        Open until {{ midterm_schedule.end_date.strftime('%b %d, %Y') }}
                                    {% endif %}
                                {% elif midterm_schedule %}
                                    Closed
                                {% else %}
                                    No schedule
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    
                    <!-- Final Status -->
                    <div class="flex items-center gap-3 p-4 rounded-xl {% if final_open %}bg-green-50 dark:bg-green-950/20 border border-green-200 dark:border-green-800{% else %}bg-base-200{% endif %}">
                        <div class="p-2 rounded-lg {% if final_open %}bg-green-500 text-white{% else %}bg-base-300 text-base-content/60{% endif %}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                        </div>
                        <div>
                            <p class="font-semibold text-base-content">Final</p>
                            <p class="text-sm text-base-content/60">
                                {% if final_open %}
                                    {% if schedule and schedule.grading_period == 'all' %}
                                        Open (All Periods)
                                    {% else %}
                                        Open until {{ final_schedule.end_date.strftime('%b %d, %Y') }}
                                    {% endif %}
                                {% elif final_schedule %}
                                    Closed
                                {% else %}
                                    No schedule
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        {% if not can_encode %}
        <div class="alert alert-warning shadow-refined-light mb-6" x-data="{ show: true }" x-show="show" x-transition>
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
                <line x1="12" y1="9" x2="12" y2="13"/>
                <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
            <div class="flex-1">
                <h4 class="font-semibold text-lg">Grade Encoding Not Available</h4>
                {% if schedule %}
                <p class="text-sm mt-1">Encoding period: {{ schedule.start_date.strftime('%B %d, %Y') }} to {{ schedule.end_date.strftime('%B %d, %Y') }}</p>
                {% else %}
                <p class="text-sm mt-1">No active grade encoding schedule. Please contact the Registrar.</p>
                {% endif %}
            </div>
            <button @click="show = false" class="btn btn-ghost btn-sm btn-circle">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        {% endif %}

        {% if grades %}
            {% set has_complete_grades = grades.values() | selectattr('is_complete', 'equalto', true) | list %}
            
            {% if has_complete_grades %}
            <div class="alert alert-success shadow-refined-light mb-6" x-data="{ show: true }" x-show="show" x-transition>
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="m9 12 2 2 4-4"/>
                </svg>
                <div class="flex-1">
                    <h4 class="font-semibold text-lg">Grades Complete</h4>
                    <p class="text-sm mt-1">All grades have been entered and are now visible to students.</p>
                </div>
                <button @click="show = false" class="btn btn-ghost btn-sm btn-circle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            {% endif %}
        {% endif %}

        <!-- Main Content Card -->
        <div class="bg-base-100 rounded-2xl border border-base-300/50 overflow-hidden shadow-refined-light">
            
            <!-- Card Header -->
            <div class="p-6 border-b border-base-300/50 bg-gradient-to-r from-indigo-50/50 to-cyan-50/50 dark:from-indigo-950/20 dark:to-cyan-950/20">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                    <div class="flex items-start gap-3">
                        <div class="p-2.5 bg-indigo-500/10 rounded-xl">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-indigo-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-semibold text-base-content mb-1">Student Grades</h2>
                            <p class="text-sm text-base-content/60">
                                {{ subject.department }} • Year {{ subject.year_level }} • Section {% if assignment and assignment.section %}{{ assignment.section }}{% else %}General{% endif %}
                            </p>
                            <p class="text-xs text-base-content/50 mt-0.5">
                                {{ subject.semester }}{% if subject.semester == 1 %}st{% else %}nd{% endif %} Semester, AY {{ assignment.school_year if assignment and assignment.school_year else (subject.academic_year or '2025-2026') }}
                            </p>
                        </div>
                    </div>
                    
                    <!-- Stats -->
                    <div class="flex flex-wrap gap-4">
                        <div class="flex items-center gap-2 px-4 py-2 bg-base-100 rounded-xl border border-base-300/50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-indigo-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect width="7" height="9" x="3" y="3" rx="1"/>
                                <rect width="7" height="5" x="14" y="3" rx="1"/>
                                <rect width="7" height="9" x="14" y="12" rx="1"/>
                                <rect width="7" height="5" x="3" y="16" rx="1"/>
                            </svg>
                            <div>
                                <p class="text-xs text-base-content/60">Section</p>
                                <p class="font-semibold text-base-content">{% if assignment and assignment.section %}{{ assignment.section }}{% else %}General{% endif %}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 px-4 py-2 bg-base-100 rounded-xl border border-base-300/50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-emerald-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                            <div>
                                <p class="text-xs text-base-content/60">Academic Year</p>
                                <p class="font-semibold text-base-content">AY {{ assignment.school_year if assignment and assignment.school_year else (subject.academic_year or '2025-2026') }}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 px-4 py-2 bg-base-100 rounded-xl border border-base-300/50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-cyan-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                            <div>
                                <p class="text-xs text-base-content/60">Students</p>
                                <p class="font-semibold text-base-content">{{ students|length }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="p-6">
                <div class="table-container overflow-x-auto rounded-xl border border-base-300/30 shadow-sm">
                    <table class="grade-table table w-full">
                        <thead>
                            <tr class="bg-gradient-to-r from-indigo-50 to-cyan-50 dark:from-indigo-950/30 dark:to-cyan-950/30">
                                <th class="text-base-content font-bold text-sm py-4 px-4 border-r border-base-300/30">
                                    <div class="flex items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-indigo-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                            <circle cx="9" cy="7" r="4"/>
                                            <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                        </svg>
                                        Student ID
                                    </div>
                                </th>
                                <th class="text-base-content font-bold text-sm py-4 px-4 border-r border-base-300/30">
                                    <div class="flex items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-indigo-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                            <circle cx="12" cy="7" r="4"/>
                                        </svg>
                                        Student Name
                                    </div>
                                </th>
                                <th class="text-base-content font-bold text-sm py-4 px-4 text-center border-r border-base-300/30">
                                    <div class="flex items-center justify-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-green-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="12" cy="12" r="10"/>
                                            <path d="M12 6v6l4 2"/>
                                        </svg>
                                        Prelim Term
                                    </div>
                                </th>
                                <th class="text-base-content font-bold text-sm py-4 px-4 text-center border-r border-base-300/30">
                                    <div class="flex items-center justify-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="12" cy="12" r="10"/>
                                            <path d="M12 6v6l4 2"/>
                                        </svg>
                                        Midterm
                                    </div>
                                </th>
                                <th class="text-base-content font-bold text-sm py-4 px-4 text-center border-r border-base-300/30">
                                    <div class="flex items-center justify-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-purple-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="12" cy="12" r="10"/>
                                            <path d="M12 6v6l4 2"/>
                                        </svg>
                                        Final Term
                                    </div>
                                </th>
                                <th class="text-base-content font-bold text-sm py-4 px-4 text-center border-r border-base-300/30">
                                    <div class="flex items-center justify-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-orange-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M9 19c-5 0-7-3-7-3s2-3 7-3 7 3 7 3-2 3-7 3z"/>
                                            <path d="M12 19c0-5 3-7 3-7s-3-2-3-7-3 2-3 7 3 7 3 7z"/>
                                        </svg>
                                        Final Grade
                                    </div>
                                </th>
                                <th class="text-base-content font-bold text-sm py-4 px-4 text-center border-r border-base-300/30">
                                    <div class="flex items-center justify-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-cyan-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                        </svg>
                                        Equivalent
                                    </div>
                                </th>
                                <th class="text-base-content font-bold text-sm py-4 px-4 text-center">
                                    <div class="flex items-center justify-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-emerald-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M9 12l2 2 4-4"/>
                                            <path d="M21 12c-1 0-3-1-3-3s2-3 3-3 3 1 3 3-2 3-3 3"/>
                                            <path d="M3 12c1 0 3-1 3-3s-2-3-3-3-3 1-3 3 2 3 3 3"/>
                                            <path d="M12 3c0 1-1 3-3 3s-3-2-3-3 1-3 3-3 3 2 3 3"/>
                                            <path d="M12 21c0-1 1-3 3-3s3 2 3 3-1 3-3 3-3-2-3-3"/>
                                        </svg>
                                        Remarks
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                            {% set grade = grades.get(student.id) %}
                            <tr class="grade-row hover:bg-base-50 dark:hover:bg-base-200/30 border-b border-base-300/20 transition-colors duration-200" 
                                data-student-id="{{ student.id }}"
                                data-complete="{{ 'true' if grade and grade.is_complete else 'false' }}">
                                <td class="font-bold text-indigo-600 py-4 px-4 border-r border-base-300/20">
                                    <div class="flex items-center gap-2">
                                        <div class="w-8 h-8 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center">
                                            <span class="text-xs font-bold text-indigo-600">{{ loop.index }}</span>
                                        </div>
                                        {{ student.student_id }}
                                    </div>
                                </td>
                                <td class="font-semibold text-base-content py-4 px-4 border-r border-base-300/20">
                                    <div class="flex flex-col">
                                        <span class="font-bold">{{ student.last_name }}, {{ student.first_name }}{% if student.middle_name %} {{ student.middle_name }}{% endif %}{% if student.suffix %} {{ student.suffix }}{% endif %}</span>
                                    </div>
                                </td>
                                <td class="py-4 px-4 text-center border-r border-base-300/20">
                                    <div class="flex justify-center">
                                    <input type="text" 
                                           name="prelim" 
                                               class="grade-input input input-sm w-24 text-center font-semibold focus:border-green-500 focus:ring-2 focus:ring-green-500/20 transition-all duration-200 {% if not prelim_open or is_registrar_access %}input-disabled bg-base-200 text-base-content/50{% endif %}"
                                           value="{{ grade.prelim_grade if grade else '' }}"
                                           {% if not prelim_open or is_registrar_access %}disabled{% endif %}
                                           onchange="calculateAverage(this.closest('tr'))"
                                           onblur="validateGrade(this)"
                                           oninput="validateNumericInput(this)"
                                           onkeypress="preventNonNumeric(event)"
                                           placeholder="0.00">
                                    </div>
                                </td>
                                <td class="py-4 px-4 text-center border-r border-base-300/20">
                                    <div class="flex justify-center">
                                    <input type="text" 
                                           name="midterm" 
                                               class="grade-input input input-sm w-24 text-center font-semibold focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all duration-200 {% if not midterm_open or is_registrar_access %}input-disabled bg-base-200 text-base-content/50{% endif %}"
                                           value="{{ grade.midterm_grade if grade else '' }}"
                                           {% if not midterm_open or is_registrar_access %}disabled{% endif %}
                                           onchange="calculateAverage(this.closest('tr'))"
                                           onblur="validateGrade(this)"
                                           oninput="validateNumericInput(this)"
                                           onkeypress="preventNonNumeric(event)"
                                           placeholder="0.00">
                                    </div>
                                </td>
                                <td class="py-4 px-4 text-center border-r border-base-300/20">
                                    <div class="flex justify-center">
                                    <input type="text" 
                                           name="final" 
                                               class="grade-input input input-sm w-24 text-center font-semibold focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all duration-200 {% if not final_open or is_registrar_access %}input-disabled bg-base-200 text-base-content/50{% endif %}"
                                           value="{{ grade.final_grade if grade else '' }}"
                                           {% if not final_open or is_registrar_access %}disabled{% endif %}
                                           onchange="calculateAverage(this.closest('tr'))"
                                           onblur="validateGrade(this)"
                                           oninput="validateNumericInput(this)"
                                           onkeypress="preventNonNumeric(event)"
                                           placeholder="0.00">
                                    </div>
                                </td>
                                <td class="py-4 px-4 text-center border-r border-base-300/20">
                                    <div class="flex justify-center">
                                        <span class="final-average font-bold text-lg px-3 py-1 rounded-lg {% if grade and grade.final_average %}bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300{% else %}text-base-content/40{% endif %}">
                                        {{ "%.2f"|format(grade.final_average) if grade and grade.final_average else '—' }}
                                    </span>
                                    </div>
                                </td>
                                <td class="py-4 px-4 text-center border-r border-base-300/20">
                                    <div class="flex justify-center">
                                        <span class="equivalent-grade font-bold text-lg px-3 py-1 rounded-lg {% if grade and grade.equivalent_grade %}bg-cyan-100 dark:bg-cyan-900/30 text-cyan-700 dark:text-cyan-300{% else %}text-base-content/40{% endif %}">
                                        {{ "%.2f"|format(grade.equivalent_grade) if grade and grade.equivalent_grade else '—' }}
                                    </span>
                                    </div>
                                </td>
                                <td class="py-4 px-4 text-center">
                                    <div class="flex justify-center">
                                        <select name="remarks" 
                                                class="select select-sm w-32 text-center font-semibold focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20 transition-all duration-200 {% if is_registrar_access %}select-disabled bg-base-200 text-base-content/50{% endif %}"
                                                {% if is_registrar_access %}disabled{% endif %}
                                                onchange="handleRemarksChange(this.closest('tr'))">
                                            <option value="">Auto</option>
                                            <option value="Passed" {% if grade and grade.remarks == 'Passed' %}selected{% endif %}>Passed</option>
                                            <option value="AW" {% if grade and grade.remarks == 'AW' %}selected{% endif %}>AW</option>
                                            <option value="UW" {% if grade and grade.remarks == 'UW' %}selected{% endif %}>UW</option>
                                            <option value="INC" {% if grade and grade.remarks == 'INC' %}selected{% endif %}>INC</option>
                                        </select>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-3 mt-6 pt-6 border-t border-base-300/50 justify-end">
                    {% if not is_registrar_access %}
                    <button onclick="saveGrades()" 
                            class="btn btn-primary gap-2 shadow-refined-light hover:shadow-refined-medium transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                            <polyline points="17 21 17 13 7 13 7 21"/>
                            <polyline points="7 3 7 8 15 8"/>
                        </svg>
                        Save
                    </button>
                    {% endif %}
                    <button onclick="printGrades()" 
                            class="btn btn-outline gap-2 shadow-refined-light hover:shadow-refined-medium transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 6 2 18 2 18 9"/>
                            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                            <rect width="12" height="8" x="6" y="14"/>
                        </svg>
                        Print Grades
                    </button>
                </div>
            </div>
        </div>
    </div>

</section>

<script>
const GRADE_SCALES = [
    { min: 98, equivalent: 1.00, remarks: "Passed" },
    { min: 95, equivalent: 1.25, remarks: "Passed" },
    { min: 92, equivalent: 1.50, remarks: "Passed" },
    { min: 89, equivalent: 1.75, remarks: "Passed" },
    { min: 86, equivalent: 2.00, remarks: "Passed" },
    { min: 83, equivalent: 2.25, remarks: "Passed" },
    { min: 80, equivalent: 2.50, remarks: "Passed" },
    { min: 77, equivalent: 2.75, remarks: "Passed" },
    { min: 75, equivalent: 3.00, remarks: "Passed" },
    { min: 0,  equivalent: 5.00, remarks: "Failed" }
];

function validateGrade(input) {
    let value = parseFloat(input.value);
    if (isNaN(value) || value < 0) {
        input.value = '';
    } else if (value > 100) {
        input.value = '100';
    }
    calculateAverage(input.closest('tr'));
}

function preventNonNumeric(event) {
    // Allow: backspace, delete, tab, escape, enter, decimal point
    if ([8, 9, 27, 13, 46, 110, 190].indexOf(event.keyCode) !== -1 ||
        // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
        (event.keyCode === 65 && event.ctrlKey === true) ||
        (event.keyCode === 67 && event.ctrlKey === true) ||
        (event.keyCode === 86 && event.ctrlKey === true) ||
        (event.keyCode === 88 && event.ctrlKey === true) ||
        // Allow: home, end, left, right, down, up
        (event.keyCode >= 35 && event.keyCode <= 40)) {
        return;
    }
    // Ensure that it is a number and stop the keypress
    if ((event.shiftKey || (event.keyCode < 48 || event.keyCode > 57)) && (event.keyCode < 96 || event.keyCode > 105)) {
        event.preventDefault();
    }
}

function validateNumericInput(input) {
    // Remove any non-numeric characters except decimal point
    let value = input.value.replace(/[^0-9.]/g, '');
    
    // Ensure only one decimal point
    let parts = value.split('.');
    if (parts.length > 2) {
        value = parts[0] + '.' + parts.slice(1).join('');
    }
    
    // Limit to 2 decimal places
    if (parts.length === 2 && parts[1].length > 2) {
        value = parts[0] + '.' + parts[1].substring(0, 2);
    }
    
    // Limit to 100 maximum
    let numValue = parseFloat(value);
    if (!isNaN(numValue) && numValue > 100) {
        value = '100';
    }
    
    input.value = value;
    calculateAverage(input.closest('tr'));
}

function calculateAverage(row) {
    const inputs = row.querySelectorAll('.grade-input');
    const remarksSelect = row.querySelector('select[name="remarks"]');
    const grades = Array.from(inputs).map(input => parseFloat(input.value));
    
    // Check if special remarks are selected
    if (remarksSelect.value && remarksSelect.value !== '') {
        handleSpecialRemarks(row, remarksSelect.value);
        return;
    }
    
    if (grades.every(grade => !isNaN(grade))) {
        const average = grades.reduce((a, b) => a + b, 0) / grades.length;
        const roundedAverage = Math.round(average * 100) / 100;
        
        // Find the appropriate grade scale
        const scale = GRADE_SCALES.find(scale => roundedAverage >= scale.min);
        
        // Add animation to updated elements
        const averageElement = row.querySelector('.final-average');
        const equivalentElement = row.querySelector('.equivalent-grade');
        const remarksElement = row.querySelector('select[name="remarks"]');
        
        averageElement.textContent = roundedAverage.toFixed(2);
        equivalentElement.textContent = scale.equivalent.toFixed(2);
        
        // Update styling based on pass/fail
        if (scale.remarks === "Passed") {
            averageElement.className = 'final-average font-bold text-lg px-3 py-1 rounded-lg bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300';
            equivalentElement.className = 'equivalent-grade font-bold text-lg px-3 py-1 rounded-lg bg-cyan-100 dark:bg-cyan-900/30 text-cyan-700 dark:text-cyan-300';
        } else {
            averageElement.className = 'final-average font-bold text-lg px-3 py-1 rounded-lg bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300';
            equivalentElement.className = 'equivalent-grade font-bold text-lg px-3 py-1 rounded-lg bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300';
        }
        
        // Add animation class
        averageElement.classList.add('grade-updated');
        equivalentElement.classList.add('grade-updated');
        
        // Remove animation class after animation completes
        setTimeout(() => {
            averageElement.classList.remove('grade-updated');
            equivalentElement.classList.remove('grade-updated');
        }, 300);
    } else {
        row.querySelector('.final-average').textContent = '—';
        row.querySelector('.equivalent-grade').textContent = '—';
        row.querySelector('.final-average').className = 'final-average font-bold text-lg px-3 py-1 rounded-lg text-base-content/40';
        row.querySelector('.equivalent-grade').className = 'equivalent-grade font-bold text-lg px-3 py-1 rounded-lg text-base-content/40';
    }
}

function handleRemarksChange(row) {
    const remarksSelect = row.querySelector('select[name="remarks"]');
    const remarksValue = remarksSelect.value;
    
    if (remarksValue && remarksValue !== '') {
        handleSpecialRemarks(row, remarksValue);
    } else {
        // Reset to auto calculation
        calculateAverage(row);
    }
}

function handleSpecialRemarks(row, remarksValue) {
    const averageElement = row.querySelector('.final-average');
    const equivalentElement = row.querySelector('.equivalent-grade');
    
    // Clear the final average and equivalent grade for special remarks
    averageElement.textContent = '—';
    equivalentElement.textContent = '—';
    
    // Style based on remarks type
    if (remarksValue === 'Passed') {
        averageElement.className = 'final-average font-bold text-lg px-3 py-1 rounded-lg bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300';
        equivalentElement.className = 'equivalent-grade font-bold text-lg px-3 py-1 rounded-lg bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300';
    } else if (remarksValue === 'AW' || remarksValue === 'UW' || remarksValue === 'INC') {
        averageElement.className = 'final-average font-bold text-lg px-3 py-1 rounded-lg bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300';
        equivalentElement.className = 'equivalent-grade font-bold text-lg px-3 py-1 rounded-lg bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300';
    }
    
    // Add animation
    averageElement.classList.add('grade-updated');
    equivalentElement.classList.add('grade-updated');
    
    setTimeout(() => {
        averageElement.classList.remove('grade-updated');
        equivalentElement.classList.remove('grade-updated');
    }, 300);
}

async function saveGrades() {
    const grades = [];
    let allGradesComplete = true;
    
    document.querySelectorAll('.grade-row').forEach(row => {
        const studentId = row.dataset.studentId;
        const inputs = row.querySelectorAll('.grade-input');
        const remarksSelect = row.querySelector('select[name="remarks"]');
        
        const prelim = inputs[0].value || null;
        const midterm = inputs[1].value || null;
        const final = inputs[2].value || null;
        const remarks = remarksSelect.value || null;
        
        // Check if all three grades are entered (unless special remarks are used)
        if (!remarks && (!prelim || !midterm || !final)) {
            allGradesComplete = false;
        }
        
        grades.push({
            student_id: studentId,
            prelim: prelim,
            midterm: midterm,
            final: final,
            remarks: remarks
        });
    });

    try {
        const response = await fetch('/api/save-grades', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                subject_id: {{ subject.id }},
                grades: grades,
                all_complete: allGradesComplete
            })
        });

        const data = await response.json();
        if (response.ok) {
            if (data.all_complete) {
                showNotification('success', 'Grades Complete!', 'All grades have been entered and are now visible to students.');
            } else {
                showNotification('success', 'Grades Saved Successfully', 'Your grades have been saved successfully.');
            }
            
            // Reload the page after a short delay to show the notification
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showNotification('error', 'Save Failed', data.message || 'Error saving grades');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('error', 'Save Error', 'An error occurred while saving grades');
    }
}


function showNotification(type, title, message) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} shadow-refined-light mb-6`;
    
    // Set up the notification content based on type
    let iconSvg = '';
    if (type === 'success') {
        iconSvg = `
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <path d="m9 12 2 2 4-4"/>
            </svg>
        `;
    } else if (type === 'error') {
        iconSvg = `
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <line x1="15" y1="9" x2="9" y2="15"/>
                <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
        `;
    } else if (type === 'warning') {
        iconSvg = `
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
                <line x1="12" y1="9" x2="12" y2="13"/>
                <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
        `;
    } else {
        iconSvg = `
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="16" x2="12" y2="12"/>
                <line x1="12" y1="8" x2="12.01" y2="8"/>
            </svg>
        `;
    }
    
    notification.innerHTML = `
        ${iconSvg}
        <div class="flex-1">
            <h4 class="font-semibold text-lg">${title}</h4>
            <p class="text-sm mt-1">${message}</p>
        </div>
        <button onclick="this.parentElement.remove()" class="btn btn-ghost btn-sm btn-circle">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
    `;
    
    // Insert notification at the top of the main content
    const mainContent = document.querySelector('.container');
    const firstChild = mainContent.firstElementChild;
    mainContent.insertBefore(notification, firstChild);
    
    // Auto-remove notification after 5 seconds (only for success notifications)
    if (type === 'success') {
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.transition = 'opacity 0.3s ease-out';
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }
        }, 5000);
    }
}


function printGrades() {
    // Create a print-friendly version of the grades table
    const printWindow = window.open('', '_blank');
    const subjectCode = '{{ subject.subject_code }}';
    const subjectName = '{{ subject.subject_name }}';
    const semester = '{{ subject.semester }}';
    const academicYear = '{{ assignment.school_year if assignment and assignment.school_year else (subject.academic_year or "2025-2026") }}';
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Grade Sheet - ${subjectCode}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 30px; }
                .header h1 { margin: 0; font-size: 24px; }
                .header h2 { margin: 5px 0; font-size: 18px; color: #666; }
                .header p { margin: 5px 0; font-size: 14px; color: #888; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f5f5f5; font-weight: bold; }
                .center { text-align: center; }
                .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #666; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>NORZAGARAY COLLEGE</h1>
                <h2>Grade Sheet</h2>
                <p><strong>Subject:</strong> ${subjectCode} - ${subjectName}</p>
                <p><strong>Semester:</strong> ${semester}${semester == 1 ? 'st' : 'nd'} Semester, AY ${academicYear}</p>
                <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Student ID</th>
                        <th>Lastname, Firstname Middlename Suffix</th>
                        <th class="center">Prelim Term</th>
                        <th class="center">Midterm</th>
                        <th class="center">Final Term</th>
                        <th class="center">Final Grade</th>
                        <th class="center">Equivalent</th>
                        <th class="center">Remarks</th>
                    </tr>
                </thead>
                <tbody>
                    ${document.querySelectorAll('.grade-row').map(row => {
                        const studentId = row.querySelector('td:first-child').textContent;
                        const studentName = row.querySelector('td:nth-child(2)').textContent;
                        const prelim = row.querySelector('input[name="prelim"]').value || '—';
                        const midterm = row.querySelector('input[name="midterm"]').value || '—';
                        const final = row.querySelector('input[name="final"]').value || '—';
                        const average = row.querySelector('.final-average').textContent;
                        const equivalent = row.querySelector('.equivalent-grade').textContent;
                        const remarks = row.querySelector('select[name="remarks"]').value || '—';
                        
                        return `
                            <tr>
                                <td>${studentId}</td>
                                <td>${studentName}</td>
                                <td class="center">${prelim}</td>
                                <td class="center">${midterm}</td>
                                <td class="center">${final}</td>
                                <td class="center">${average}</td>
                                <td class="center">${equivalent}</td>
                                <td class="center">${remarks}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
            
            <div class="footer">
                <p>Generated on ${new Date().toLocaleString()}</p>
            </div>
        </body>
        </html>
    `);
    
    printWindow.document.close();
    printWindow.print();
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Grade encoding page loaded');
    
    // Initialize remarks for existing grades
    document.querySelectorAll('.grade-row').forEach(row => {
        const inputs = row.querySelectorAll('.grade-input');
        const remarksSelect = row.querySelector('select[name="remarks"]');
        const grades = Array.from(inputs).map(input => parseFloat(input.value));
        
        // Check if special remarks are already set
        if (remarksSelect.value && remarksSelect.value !== '') {
            handleSpecialRemarks(row, remarksSelect.value);
        } else if (grades.every(grade => !isNaN(grade))) {
            calculateAverage(row);
        }
    });
    
    // Prevent scroll/wheel events on grade inputs
    document.querySelectorAll('.grade-input').forEach(input => {
        input.addEventListener('wheel', function(e) {
            e.preventDefault();
            e.stopPropagation();
        }, { passive: false });
        
        input.addEventListener('scroll', function(e) {
            e.preventDefault();
            e.stopPropagation();
        }, { passive: false });
        
        // Prevent mouse wheel from changing values
        input.addEventListener('mousewheel', function(e) {
            e.preventDefault();
            e.stopPropagation();
        }, { passive: false });
        
        // Prevent DOMMouseScroll (Firefox)
        input.addEventListener('DOMMouseScroll', function(e) {
            e.preventDefault();
            e.stopPropagation();
        }, { passive: false });
        
        // Prevent paste of non-numeric content
        input.addEventListener('paste', function(e) {
            e.preventDefault();
            let paste = (e.clipboardData || window.clipboardData).getData('text');
            let numericPaste = paste.replace(/[^0-9.]/g, '');
            
            // Validate the pasted content
            let parts = numericPaste.split('.');
            if (parts.length > 2) {
                numericPaste = parts[0] + '.' + parts.slice(1).join('');
            }
            
            if (parts.length === 2 && parts[1].length > 2) {
                numericPaste = parts[0] + '.' + parts[1].substring(0, 2);
            }
            
            let numValue = parseFloat(numericPaste);
            if (!isNaN(numValue) && numValue <= 100) {
                this.value = numericPaste;
                calculateAverage(this.closest('tr'));
            }
        });
    });
});

// Real-time updates for assignment changes
let lastUpdateTime = new Date().toISOString();

function checkForAssignmentUpdates() {
    fetch('/api/get-assignment-updates', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success' && data.count > 0) {
            // Check if there are new assignments since last update
            const newAssignments = data.assignments.filter(assignment => 
                new Date(assignment.created_at) > new Date(lastUpdateTime)
            );
            
            if (newAssignments.length > 0) {
                // Check if any new assignments affect this subject
                const currentSubjectCode = '{{ subject.subject_code }}';
                const relevantAssignments = newAssignments.filter(assignment => 
                    assignment.subject_code === currentSubjectCode
                );
                
                if (relevantAssignments.length > 0) {
                    showAssignmentUpdateNotification(relevantAssignments);
                    lastUpdateTime = new Date().toISOString();
                }
            }
        }
    })
    .catch(error => {
        console.error('Error checking for assignment updates:', error);
    });
}

function showAssignmentUpdateNotification(assignments) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 z-50 bg-green-50 border-l-4 border-green-500 p-4 rounded-lg shadow-lg';
    
    const assignmentText = assignments.length === 1 ? 
        `Assignment updated: ${assignments[0].subject_code} - ${assignments[0].instructor_name}` :
        `${assignments.length} assignments updated for this subject`;
    
    notification.innerHTML = `
        <div class="flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-green-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            <span class="text-sm font-medium text-green-800">${assignmentText}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove notification after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.transition = 'opacity 0.3s ease-out';
            notification.style.opacity = '0';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }
    }, 5000);
}

// Check for assignment updates every 30 seconds
setInterval(checkForAssignmentUpdates, 30000);

// Initial check after page load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(checkForAssignmentUpdates, 5000); // Check after 5 seconds
});
</script>
{% endblock %}
