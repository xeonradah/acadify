{% extends "common/base.html" %}

{% block title %}Grade Encoding Schedule - Acadify{% endblock %}

{% block content %}
<section class="fade-in min-h-screen" 
         x-data="{ 
             showDeleteModal: false, 
             deleteId: null,
             showCloseModal: false,
             closeId: null,
             showScheduleModal: false,
             showEditModal: false,
             showRestrictionModal: false,
             editId: null,
             editForm: {
                 academic_year: '',
                 semester: '',
                 grading_period: '',
                 status: '',
                 department: '',
                 start_date: '',
                 end_date: '',
                 start_time: '',
                 end_time: ''
             },
             init() {
                 // Listen for edit-schedule event
                 document.addEventListener('edit-schedule', (e) => {
                     const data = e.detail;
                     this.editId = data.id;
                     this.editForm.academic_year = data.academic_year;
                     this.editForm.semester = data.semester;
                     this.editForm.grading_period = data.grading_period;
                     this.editForm.status = data.status;
                     this.editForm.department = data.department;
                     this.editForm.start_date = data.start_date;
                     this.editForm.end_date = data.end_date;
                     this.editForm.start_time = data.start_time;
                     this.editForm.end_time = data.end_time;
                     this.showEditModal = true;
                 });
             }
         }">
    <div class="container max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Header -->
        <div class="mb-8">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-violet-500 to-purple-600 flex items-center justify-center shadow-lg shadow-violet-500/30">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect width="18" height="18" x="3" y="4" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                            <path d="m9 16 2 2 4-4"/>
                        </svg>
                    </div>
                    <div>
                        <div class="flex items-center gap-3 flex-wrap">
                            <h1 class="text-2xl md:text-3xl font-bold text-base-content tracking-tight">Grade Encoding Schedule</h1>
                            <span id="statusIndicator" class="badge badge-ghost badge-sm gap-1.5 hidden md:inline-flex">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 animate-pulse" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="m9 12 2 2 4-4"/>
                                </svg>
                                <span id="statusText">Live monitoring</span>
                            </span>
                        </div>
                        <p class="text-sm text-base-content/60 mt-1">
                            Manage and monitor grade submission periods
                            <span class="md:hidden inline-block ml-2">
                                <span id="mobileStatusIndicator" class="badge badge-ghost badge-xs gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-2.5 h-2.5" viewBox="0 0 24 24" fill="currentColor">
                                        <circle cx="12" cy="12" r="10"/>
                                    </svg>
                                    <span id="mobileStatusText">Live</span>
                                </span>
                            </span>
                        </p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button @click="showRestrictionModal = true" 
                            class="btn btn-warning gap-2 shadow-lg hover:shadow-xl transition-all duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect width="18" height="11" x="3" y="11" rx="2" ry="2"/>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                        </svg>
                        Restriction
                    </button>
                    <button @click="showScheduleModal = true" 
                            class="btn btn-primary gap-2 shadow-lg hover:shadow-xl transition-all duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 8v8"/>
                            <path d="M8 12h8"/>
                        </svg>
                        New Schedule
                    </button>
                </div>
            </div>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} shadow-lg mb-6" x-data="{ show: true }" x-show="show" x-transition>
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            {% if category == 'success' %}
                            <circle cx="12" cy="12" r="10"/>
                            <path d="m9 12 2 2 4-4"/>
                            {% elif category == 'error' or category == 'danger' %}
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="15" y1="9" x2="9" y2="15"/>
                            <line x1="9" y1="9" x2="15" y2="15"/>
                            {% else %}
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="16" x2="12" y2="12"/>
                            <line x1="12" y1="8" x2="12.01" y2="8"/>
                            {% endif %}
                        </svg>
                        <span class="flex-1">{{ message }}</span>
                        <button @click="show = false" class="btn btn-ghost btn-sm btn-circle">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Active Schedules -->
            <div class="bg-base-100 rounded-2xl p-6 border border-base-300/50 hover:shadow-xl hover:border-success/30 transition-all duration-300">
                <div class="flex items-start justify-between mb-4">
                    <div class="p-3 bg-success/10 rounded-xl">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-success" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="m9 12 2 2 4-4"/>
                        </svg>
                    </div>
                    <span class="badge badge-success badge-sm">Active</span>
                </div>
                <div>
                    <p class="text-4xl font-bold text-base-content mb-1">{{ schedules|selectattr('status', 'equalto', 'active')|list|length }}</p>
                    <p class="text-sm text-base-content/60">Active encoding periods</p>
                </div>
            </div>

            <!-- Upcoming Schedules -->
            <div class="bg-base-100 rounded-2xl p-6 border border-base-300/50 hover:shadow-xl hover:border-info/30 transition-all duration-300">
                <div class="flex items-start justify-between mb-4">
                    <div class="p-3 bg-info/10 rounded-xl">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-info" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                    </div>
                    <span class="badge badge-info badge-sm">Upcoming</span>
                </div>
                <div>
                    <p class="text-4xl font-bold text-base-content mb-1">{{ schedules|selectattr('status', 'equalto', 'upcoming')|list|length }}</p>
                    <p class="text-sm text-base-content/60">Future encoding periods</p>
                </div>
            </div>

            <!-- Completed Schedules -->
            <div class="bg-base-100 rounded-2xl p-6 border border-base-300/50 hover:shadow-xl hover:border-base-300 transition-all duration-300">
                <div class="flex items-start justify-between mb-4">
                    <div class="p-3 bg-base-300 rounded-xl">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-base-content" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 3v18h18"/>
                            <path d="m19 9-5 5-4-4-3 3"/>
                        </svg>
                    </div>
                    <span class="badge badge-ghost badge-sm">Completed</span>
                </div>
                <div>
                    <p class="text-4xl font-bold text-base-content mb-1">{{ schedules|selectattr('status', 'equalto', 'completed')|list|length }}</p>
                    <p class="text-sm text-base-content/60">Past encoding periods</p>
                </div>
            </div>
        </div>

        <!-- Active Schedules Table -->
        <div class="bg-base-100 rounded-2xl border border-base-300/50 overflow-hidden shadow-sm mb-8">
            <div class="p-6 border-b border-base-300/50">
                <div class="flex items-center gap-3">
                    <div class="p-2.5 bg-success/10 rounded-xl">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-success" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="m9 12 2 2 4-4"/>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-base-content">Active Schedules</h2>
                        <p class="text-sm text-base-content/60">Currently active grade encoding periods</p>
                    </div>
                </div>
            </div>

            <div class="p-6">
                {% set active_schedules = schedules|selectattr('status', 'in', ['active', 'upcoming'])|list %}
                {% if active_schedules %}
                    <div class="overflow-x-auto">
                        <table class="table w-full">
                            <thead>
                                <tr class="border-base-300/50">
                                    <th class="bg-base-200/50 text-base-content/70 font-semibold">Academic Year</th>
                                    <th class="bg-base-200/50 text-base-content/70 font-semibold">Semester</th>
                                    <th class="bg-base-200/50 text-base-content/70 font-semibold">Department</th>
                                    <th class="bg-base-200/50 text-base-content/70 font-semibold">Grading Period</th>
                                    <th class="bg-base-200/50 text-base-content/70 font-semibold">Start Date</th>
                                    <th class="bg-base-200/50 text-base-content/70 font-semibold">End Date</th>
                                    <th class="bg-base-200/50 text-base-content/70 font-semibold">Status</th>
                                    <th class="bg-base-200/50 text-base-content/70 font-semibold text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for schedule in active_schedules %}
                                <tr class="hover border-base-300/50">
                                    <td class="font-medium text-base-content">{{ schedule.academic_year }}</td>
                                    <td class="text-base-content/80">
                                        <div class="flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-base-content/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                            </svg>
                                            {{ schedule.semester }}{% if schedule.semester == 1 %}st{% else %}nd{% endif %} Semester
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge badge-ghost gap-1.5">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                                                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                                            </svg>
                                            {{ schedule.department or 'All Departments' }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge badge-outline gap-1.5">
                                            {% if schedule.grading_period == 'all' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M3 3v18h18"/>
                                                <path d="m19 9-5 5-4-4-3 3"/>
                                            </svg>
                                            All Periods
                                            {% elif schedule.grading_period == 'prelim' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <circle cx="12" cy="12" r="10"/>
                                                <path d="M12 6v6l4 2"/>
                                            </svg>
                                            Prelim
                                            {% elif schedule.grading_period == 'midterm' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <circle cx="12" cy="12" r="10"/>
                                                <path d="M12 6v6l4 2"/>
                                            </svg>
                                            Midterm
                                            {% else %}
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <circle cx="12" cy="12" r="10"/>
                                                <path d="M12 6v6l4 2"/>
                                            </svg>
                                            Final
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td class="text-base-content/70 text-sm">{{ schedule.start_date.strftime('%b %d, %Y') }}</td>
                                    <td class="text-base-content/70 text-sm">{{ schedule.end_date.strftime('%b %d, %Y') }}</td>
                                    <td>
                                        <span class="badge badge-md 
                                            {% if schedule.status == 'active' %}badge-success gap-1.5
                                            {% elif schedule.status == 'upcoming' %}badge-info gap-1.5
                                            {% else %}badge-ghost gap-1.5{% endif %}">
                                            {% if schedule.status == 'active' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <circle cx="12" cy="12" r="10"/>
                                                <path d="m9 12 2 2 4-4"/>
                                            </svg>
                                            {% elif schedule.status == 'upcoming' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <circle cx="12" cy="12" r="10"/>
                                                <polyline points="12 6 12 12 16 14"/>
                                            </svg>
                                            {% else %}
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M3 3v18h18"/>
                                                <path d="m19 9-5 5-4-4-3 3"/>
                                            </svg>
                                            {% endif %}
                                            {{ schedule.status|title }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <div class="flex gap-2 justify-center items-center">
                                            {% if schedule.status == 'active' %}
                                            <button @click="closeId = {{ schedule.id }}; showCloseModal = true"
                                                    class="flex items-center justify-center gap-1 px-3 py-2 border-2 border-warning text-warning hover:bg-warning hover:text-warning-content rounded-lg transition-all duration-200 hover:shadow-md"
                                                    title="Close schedule">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <circle cx="12" cy="12" r="10"/>
                                                    <line x1="15" y1="9" x2="9" y2="15"/>
                                                    <line x1="9" y1="9" x2="15" y2="15"/>
                                                </svg>
                                                <span class="text-sm font-medium">Close</span>
                                            </button>
                                            {% endif %}
                                            <button class="edit-schedule-btn flex items-center justify-center gap-1 px-3 py-2 border-2 border-primary text-primary hover:bg-primary hover:text-primary-content rounded-lg transition-all duration-200 hover:shadow-md"
                                                    title="Edit schedule"
                                                    data-schedule-id="{{ schedule.id }}"
                                                    data-academic-year="{{ schedule.academic_year }}"
                                                    data-semester="{{ schedule.semester }}"
                                                    data-grading-period="{{ schedule.grading_period }}"
                                                    data-status="{{ schedule.status }}"
                                                    data-department="{{ schedule.department or '' }}"
                                                    data-start-date="{{ schedule.start_date.strftime('%Y-%m-%d') }}"
                                                    data-end-date="{{ schedule.end_date.strftime('%Y-%m-%d') }}"
                                                    data-start-time="{{ schedule.start_time or '' }}"
                                                    data-end-time="{{ schedule.end_time or '' }}">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                                    <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                                </svg>
                                                <span class="text-sm font-medium">Edit</span>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <!-- Empty State -->
                    <div class="text-center py-16">
                        <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-success/10 mb-6">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-success" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="m9 12 2 2 4-4"/>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-base-content mb-2">No active schedules</h3>
                        <p class="text-base-content/60 mb-6 max-w-md mx-auto">Create a new schedule to start managing grade encoding periods.</p>
                        <button @click="showScheduleModal = true" 
                                class="btn btn-primary gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 8v8"/>
                                <path d="M8 12h8"/>
                            </svg>
                            Create Schedule
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Archive Section -->
        <div class="bg-base-100 rounded-2xl border border-base-300/50 overflow-hidden shadow-sm">
            <div class="p-6 border-b border-base-300/50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="p-2.5 bg-base-300/50 rounded-xl">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-base-content" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect width="20" height="5" x="2" y="3" rx="1"/>
                                <path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"/>
                                <path d="M10 12h4"/>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-base-content">Archive</h2>
                            <p class="text-sm text-base-content/60">Completed grade encoding periods</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="badge badge-ghost">{{ schedules|selectattr('status', 'equalto', 'completed')|list|length }} completed</span>
                    </div>
                </div>
            </div>

            <div class="p-6">
                {% set completed_schedules = schedules|selectattr('status', 'equalto', 'completed')|list %}
                {% if completed_schedules %}
                    <div class="overflow-x-auto">
                        <table class="table w-full">
                            <thead>
                                <tr class="border-base-300/50">
                                    <th class="bg-base-200/50 text-base-content/70 font-semibold">Academic Year</th>
                                    <th class="bg-base-200/50 text-base-content/70 font-semibold">Semester</th>
                                    <th class="bg-base-200/50 text-base-content/70 font-semibold">Department</th>
                                    <th class="bg-base-200/50 text-base-content/70 font-semibold">Grading Period</th>
                                    <th class="bg-base-200/50 text-base-content/70 font-semibold">Start Date</th>
                                    <th class="bg-base-200/50 text-base-content/70 font-semibold">End Date</th>
                                    <th class="bg-base-200/50 text-base-content/70 font-semibold">Completed Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for schedule in completed_schedules %}
                                <tr class="hover border-base-300/50">
                                    <td class="font-medium text-base-content">{{ schedule.academic_year }}</td>
                                    <td class="text-base-content/80">
                                        <div class="flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-base-content/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                            </svg>
                                            {{ schedule.semester }}{% if schedule.semester == 1 %}st{% else %}nd{% endif %} Semester
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge badge-ghost gap-1.5">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                                                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                                            </svg>
                                            {{ schedule.department or 'All Departments' }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge badge-outline gap-1.5">
                                            {% if schedule.grading_period == 'all' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M3 3v18h18"/>
                                                <path d="m19 9-5 5-4-4-3 3"/>
                                            </svg>
                                            All Periods
                                            {% elif schedule.grading_period == 'prelim' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <circle cx="12" cy="12" r="10"/>
                                                <path d="M12 6v6l4 2"/>
                                            </svg>
                                            Prelim
                                            {% elif schedule.grading_period == 'midterm' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <circle cx="12" cy="12" r="10"/>
                                                <path d="M12 6v6l4 2"/>
                                            </svg>
                                            Midterm
                                            {% else %}
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <circle cx="12" cy="12" r="10"/>
                                                <path d="M12 6v6l4 2"/>
                                            </svg>
                                            Final
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td class="text-base-content/70 text-sm">{{ schedule.start_date.strftime('%b %d, %Y') }}</td>
                                    <td class="text-base-content/70 text-sm">{{ schedule.end_date.strftime('%b %d, %Y') }}</td>
                                    <td class="text-base-content/70 text-sm">
                                        <span class="badge badge-ghost gap-1.5">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M3 3v18h18"/>
                                                <path d="m19 9-5 5-4-4-3 3"/>
                                            </svg>
                                            {{ schedule.end_date.strftime('%b %d, %Y') }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <!-- Empty Archive State -->
                    <div class="text-center py-12">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-base-300/30 mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-base-content/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect width="20" height="5" x="2" y="3" rx="1"/>
                                <path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"/>
                                <path d="M10 12h4"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-base-content mb-2">No completed schedules</h3>
                        <p class="text-base-content/60">Completed schedules will appear here for reference.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Schedule Modal -->
    <div x-show="showScheduleModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-base-content/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
         @click.self="showScheduleModal = false"
         style="display: none;">
        <div x-show="showScheduleModal"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             class="bg-base-100 rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            
            <!-- Modal Header -->
            <div class="sticky top-0 bg-base-100 p-6 border-b border-base-300/50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="p-2.5 bg-violet-500/10 rounded-xl">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-violet-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect width="18" height="18" x="3" y="4" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-base-content">New Schedule</h3>
                            <p class="text-sm text-base-content/60">Create grade encoding period</p>
                        </div>
                    </div>
                    <button @click="showScheduleModal = false" 
                            class="btn btn-ghost btn-sm btn-circle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Modal Body -->
            <form id="scheduleForm" method="POST" class="p-6 space-y-5">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Academic Year</span>
                    </label>
                    <input type="text" name="academic_year" required pattern="\d{4}-\d{4}"
                           placeholder="e.g., 2025-2026" value="2025-2026"
                           class="input input-bordered w-full focus:border-violet-500 focus:ring-2 focus:ring-violet-500/20">
                </div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Semester</span>
                    </label>
                    <select name="semester" required class="select select-bordered w-full focus:border-violet-500 focus:ring-2 focus:ring-violet-500/20">
                        <option value="" disabled>Select Semester</option>
                        <option value="1" selected>1st Semester</option>
                        <option value="2">2nd Semester</option>
                    </select>
                </div>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Grading Period</span>
                    </label>
                    <select name="grading_period" required class="select select-bordered w-full focus:border-violet-500 focus:ring-2 focus:ring-violet-500/20">
                        <option value="all">All Periods</option>
                        <option value="prelim">Prelim Only</option>
                        <option value="midterm">Midterm Only</option>
                        <option value="final">Final Only</option>
                    </select>
                </div>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Status</span>
                    </label>
                    <select name="status" required class="select select-bordered w-full focus:border-violet-500 focus:ring-2 focus:ring-violet-500/20">
                        <option value="active" selected>Active</option>
                        <option value="upcoming">Upcoming</option>
                    </select>
                </div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Department</span>
                        <span class="label-text-alt text-base-content/40">Optional</span>
                    </label>
                    <select name="department" class="select select-bordered w-full focus:border-violet-500 focus:ring-2 focus:ring-violet-500/20">
                        <option value="">All Departments</option>
                        <option value="BSCS">BSCS</option>
                        <option value="BEED">BEED</option>
                        <option value="BSHM">BSHM</option>
                        <option value="BSED">BSED</option>
                    </select>
                </div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Start Date</span>
                    </label>
                    <input type="date" name="start_date" required 
                           class="input input-bordered w-full focus:border-violet-500 focus:ring-2 focus:ring-violet-500/20">
                </div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">End Date</span>
                    </label>
                    <input type="date" name="end_date" required 
                           class="input input-bordered w-full focus:border-violet-500 focus:ring-2 focus:ring-violet-500/20">
                </div>

                <!-- For Testing - Time Fields -->
                <div class="divider text-sm text-base-content/60">For Testing</div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Start Time</span>
                        <span class="label-text-alt text-base-content/40">Optional</span>
                    </label>
                    <input type="time" name="start_time" 
                           class="input input-bordered w-full focus:border-violet-500 focus:ring-2 focus:ring-violet-500/20">
                </div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">End Time</span>
                        <span class="label-text-alt text-base-content/40">Optional</span>
                    </label>
                    <input type="time" name="end_time" 
                           class="input input-bordered w-full focus:border-violet-500 focus:ring-2 focus:ring-violet-500/20">
                </div>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" @click="showScheduleModal = false"
                            class="btn btn-ghost">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                            <polyline points="17 21 17 13 7 13 7 21"/>
                            <polyline points="7 3 7 8 15 8"/>
                        </svg>
                        Create Schedule
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Close Confirmation Modal -->
    <div x-show="showCloseModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-base-content/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
         @click.self="showCloseModal = false"
         style="display: none;">
        <div x-show="showCloseModal"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             class="bg-base-100 rounded-2xl shadow-2xl max-w-md w-full">
            
            <!-- Modal Header -->
            <div class="p-6 border-b border-base-300/50">
                <div class="flex items-center gap-3">
                    <div class="p-2.5 bg-warning/10 rounded-xl">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-warning" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="15" y1="9" x2="9" y2="15"/>
                            <line x1="9" y1="9" x2="15" y2="15"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-base-content">Close Schedule?</h3>
                        <p class="text-sm text-base-content/60">End the grade encoding period immediately</p>
                    </div>
                </div>
            </div>

            <!-- Modal Body -->
            <div class="p-6">
                <p class="text-base-content/80 mb-6">
                    Are you sure you want to close this grade encoding schedule? This will immediately end the encoding period and prevent instructors from entering more grades. This action can be reversed by creating a new schedule.
                </p>
                <div class="flex justify-end gap-3">
                    <button @click="showCloseModal = false" 
                            class="btn btn-ghost">
                        Cancel
                    </button>
                    <button @click="confirmClose(closeId)" 
                            class="btn btn-warning gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="15" y1="9" x2="9" y2="15"/>
                            <line x1="9" y1="9" x2="15" y2="15"/>
                        </svg>
                        Close Schedule
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div x-show="showDeleteModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-base-content/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
         @click.self="showDeleteModal = false"
         style="display: none;">
        <div x-show="showDeleteModal"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             class="bg-base-100 rounded-2xl shadow-2xl max-w-md w-full">
            
            <!-- Modal Header -->
            <div class="p-6 border-b border-base-300/50">
                <div class="flex items-center gap-3">
                    <div class="p-2.5 bg-error/10 rounded-xl">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-error" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-base-content">Delete Schedule?</h3>
                        <p class="text-sm text-base-content/60">This action cannot be undone</p>
                    </div>
                </div>
            </div>

            <!-- Modal Body -->
            <div class="p-6">
                <p class="text-base-content/80 mb-6">
                    Are you sure you want to delete this schedule? All associated data will be permanently removed. This action is irreversible.
                </p>
                <div class="flex justify-end gap-3">
                    <button @click="showDeleteModal = false" 
                            class="btn btn-ghost">
                        Cancel
                    </button>
                    <button @click="confirmDelete(deleteId)" 
                            class="btn btn-error gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 6h18"/>
                            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                        </svg>
                        Delete Schedule
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Schedule Modal -->
    <div x-show="showEditModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-base-content/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
         @click.self="showEditModal = false"
         style="display: none;">
        <div x-show="showEditModal"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             class="bg-base-100 rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            
            <!-- Modal Header -->
            <div class="sticky top-0 bg-base-100 p-6 border-b border-base-300/50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="p-2.5 bg-primary/10 rounded-xl">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-base-content">Edit Schedule</h3>
                            <p class="text-sm text-base-content/60">Modify grade encoding period</p>
                        </div>
                    </div>
                    <button @click="showEditModal = false" 
                            class="btn btn-ghost btn-sm btn-circle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Modal Body -->
            <form id="editScheduleForm" method="POST" class="p-6 space-y-5">
                <input type="hidden" name="schedule_id" :value="editId">
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Academic Year</span>
                    </label>
                    <input type="text" name="academic_year" required pattern="\d{4}-\d{4}"
                           x-model="editForm.academic_year"
                           placeholder="e.g., 2025-2026"
                           class="input input-bordered w-full focus:border-primary focus:ring-2 focus:ring-primary/20">
                    <div class="label">
                        <span class="label-text-alt text-base-content/60">Must be unique for the same semester and grading period</span>
                    </div>
                </div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Semester</span>
                    </label>
                    <select name="semester" required class="select select-bordered w-full focus:border-primary focus:ring-2 focus:ring-primary/20">
                        <option value="" disabled>Select Semester</option>
                        <option value="1" :selected="editForm.semester == 1">1st Semester</option>
                        <option value="2" :selected="editForm.semester == 2">2nd Semester</option>
                    </select>
                </div>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Grading Period</span>
                    </label>
                    <select name="grading_period" required class="select select-bordered w-full focus:border-primary focus:ring-2 focus:ring-primary/20">
                        <option value="all" :selected="editForm.grading_period == 'all'">All Periods</option>
                        <option value="prelim" :selected="editForm.grading_period == 'prelim'">Prelim Only</option>
                        <option value="midterm" :selected="editForm.grading_period == 'midterm'">Midterm Only</option>
                        <option value="final" :selected="editForm.grading_period == 'final'">Final Only</option>
                    </select>
                </div>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Status</span>
                    </label>
                    <select name="status" required class="select select-bordered w-full focus:border-primary focus:ring-2 focus:ring-primary/20">
                        <option value="active" :selected="editForm.status == 'active'">Active</option>
                        <option value="upcoming" :selected="editForm.status == 'upcoming'">Upcoming</option>
                    </select>
                </div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Department</span>
                        <span class="label-text-alt text-base-content/40">Optional</span>
                    </label>
                    <select name="department" class="select select-bordered w-full focus:border-primary focus:ring-2 focus:ring-primary/20">
                        <option value="" :selected="editForm.department == ''">All Departments</option>
                        <option value="BSCS" :selected="editForm.department == 'BSCS'">BSCS</option>
                        <option value="BEED" :selected="editForm.department == 'BEED'">BEED</option>
                        <option value="BSHM" :selected="editForm.department == 'BSHM'">BSHM</option>
                        <option value="BSED" :selected="editForm.department == 'BSED'">BSED</option>
                    </select>
                </div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Start Date</span>
                    </label>
                    <input type="date" name="start_date" required 
                           x-model="editForm.start_date"
                           class="input input-bordered w-full focus:border-primary focus:ring-2 focus:ring-primary/20">
                </div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">End Date</span>
                    </label>
                    <input type="date" name="end_date" required 
                           x-model="editForm.end_date"
                           class="input input-bordered w-full focus:border-primary focus:ring-2 focus:ring-primary/20">
                </div>

                <!-- For Testing - Time Fields -->
                <div class="divider text-sm text-base-content/60">For Testing</div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Start Time</span>
                        <span class="label-text-alt text-base-content/40">Optional</span>
                    </label>
                    <input type="time" name="start_time" 
                           x-model="editForm.start_time"
                           class="input input-bordered w-full focus:border-primary focus:ring-2 focus:ring-primary/20">
                </div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">End Time</span>
                        <span class="label-text-alt text-base-content/40">Optional</span>
                    </label>
                    <input type="time" name="end_time" 
                           x-model="editForm.end_time"
                           class="input input-bordered w-full focus:border-primary focus:ring-2 focus:ring-primary/20">
                </div>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" @click="showEditModal = false"
                            class="btn btn-ghost">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                        Update Schedule
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Restriction Modal -->
    <div x-show="showRestrictionModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-base-content/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
         @click.self="showRestrictionModal = false"
         style="display: none;">
        <div x-show="showRestrictionModal"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             class="bg-base-100 rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
            
            <!-- Modal Header -->
            <div class="sticky top-0 bg-base-100 p-6 border-b border-base-300/50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="p-2.5 bg-warning/10 rounded-xl">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-warning" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect width="18" height="11" x="3" y="11" rx="2" ry="2"/>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-base-content">Encoding Restriction Management</h3>
                            <p class="text-sm text-base-content/60">Grant special access to instructors after schedule closure</p>
                        </div>
                    </div>
                    <button @click="showRestrictionModal = false" 
                            class="btn btn-ghost btn-sm btn-circle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Modal Body -->
            <div class="p-6 space-y-6">
                <!-- Grant Access Form -->
                <div class="bg-base-100 rounded-2xl border border-base-300/50 overflow-hidden shadow-sm">
                    <div class="p-6 border-b border-base-300/50">
                        <div>
                            <h4 class="text-lg font-semibold text-base-content">Grant Encoding Access</h4>
                            <p class="text-sm text-base-content/60">Allow instructors to encode grades after schedule closure</p>
                        </div>
                    </div>

                    <div class="p-6">
                        <form id="grantAccessForm" class="space-y-5">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <!-- Instructor Selection -->
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text font-medium">Select Instructor</span>
                                        <span class="label-text-alt text-error">*</span>
                                    </label>
                                    <select name="instructor_id" required class="select select-bordered w-full focus:border-success focus:ring-2 focus:ring-success/20">
                                        <option value="">Choose instructor...</option>
                                        {% for instructor in instructors %}
                                        <option value="{{ instructor.id }}">
                                            {{ instructor.first_name }} {{ instructor.last_name }}
                                            {% if instructor.department %} - {{ instructor.department }}{% endif %}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- Academic Year -->
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text font-medium">Academic Year</span>
                                        <span class="label-text-alt text-error">*</span>
                                    </label>
                                    <select name="academic_year" required class="select select-bordered w-full focus:border-success focus:ring-2 focus:ring-success/20">
                                        <option value="">Select year...</option>
                                        <option value="2024-2025">2024-2025</option>
                                        <option value="2025-2026" selected>2025-2026</option>
                                        <option value="2026-2027">2026-2027</option>
                                    </select>
                                </div>

                                <!-- Semester -->
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text font-medium">Semester</span>
                                        <span class="label-text-alt text-error">*</span>
                                    </label>
                                    <select name="semester" required class="select select-bordered w-full focus:border-success focus:ring-2 focus:ring-success/20">
                                        <option value="">Select semester...</option>
                                        <option value="1">1st Semester</option>
                                        <option value="2">2nd Semester</option>
                                    </select>
                                </div>

                                <!-- Grading Period -->
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text font-medium">Grading Period</span>
                                        <span class="label-text-alt text-error">*</span>
                                    </label>
                                    <select name="grading_period" required class="select select-bordered w-full focus:border-success focus:ring-2 focus:ring-success/20">
                                        <option value="">Select period...</option>
                                        <option value="all">All Periods</option>
                                        <option value="prelim">Prelim</option>
                                        <option value="midterm">Midterm</option>
                                        <option value="final">Final</option>
                                    </select>
                                </div>

                                <!-- Expiration Date -->
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text font-medium">Access Expiration Date</span>
                                        <span class="label-text-alt text-base-content/40">Optional</span>
                                    </label>
                                    <input type="date" name="expiration_date" id="expiration_date" class="input input-bordered w-full focus:border-success focus:ring-2 focus:ring-success/20" />
                                    <label class="label">
                                        <span class="label-text-alt text-base-content/60">Specify a date, or leave blank for time-only access</span>
                                    </label>
                                </div>

                                <!-- Expiration Time -->
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text font-medium">Expiration Time</span>
                                        <span class="label-text-alt text-base-content/40">Optional</span>
                                    </label>
                                    <input type="time" name="expiration_time" id="expiration_time" class="input input-bordered w-full focus:border-success focus:ring-2 focus:ring-success/20" placeholder="23:59" />
                                    <label class="label">
                                        <span class="label-text-alt text-base-content/60">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 inline-block mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <circle cx="12" cy="12" r="10"/>
                                                <line x1="12" y1="16" x2="12" y2="12"/>
                                                <line x1="12" y1="8" x2="12.01" y2="8"/>
                                            </svg>
                                            Specify a time, or leave blank for end of day (11:59 PM)
                                        </span>
                                    </label>
                                </div>

                            </div>

                            <!-- Form Actions -->
                            <div class="flex justify-end gap-3 pt-4 border-t border-base-300/50">
                                <button type="button" @click="showRestrictionModal = false" class="btn btn-ghost">
                                    Cancel
                                </button>
                                <button type="submit" class="btn btn-success text-white gap-2 shadow-lg hover:shadow-xl transition-all duration-300">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M5 13l4 4L19 7"/>
                                    </svg>
                                    Grant Access
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Active Exceptions List -->
                <div class="bg-base-100 rounded-2xl border border-base-300/50 overflow-hidden shadow-sm">
                    <div class="p-6 border-b border-base-300/50">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="p-2.5 bg-warning/10 rounded-xl">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-warning" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M12 6v6l4 2"/>
                                        <circle cx="12" cy="12" r="10"/>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="text-lg font-semibold text-base-content">Active Access Grants</h4>
                                    <p class="text-sm text-base-content/60">Currently granted encoding exceptions  Auto-expires on expiration date</p>
                                </div>
                            </div>
                            <span class="badge badge-warning badge-sm gap-1.5">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="m9 12 2 2 4-4"/>
                                </svg>
                                Auto-monitored
                            </span>
                        </div>
                    </div>

                    <div class="p-6">
                        {% if exceptions %}
                        <div class="overflow-x-auto">
                            <table class="table w-full">
                                <thead>
                                    <tr class="border-base-300/50">
                                        <th class="bg-base-200/50 text-base-content/70 font-semibold">Instructor</th>
                                        <th class="bg-base-200/50 text-base-content/70 font-semibold">Academic Period</th>
                                        <th class="bg-base-200/50 text-base-content/70 font-semibold">Grading Period</th>
                                        <th class="bg-base-200/50 text-base-content/70 font-semibold">Expires</th>
                                        <th class="bg-base-200/50 text-base-content/70 font-semibold">Granted By</th>
                                        <th class="bg-base-200/50 text-base-content/70 font-semibold text-center">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for exception in exceptions %}
                                    <tr class="hover border-base-300/50">
                                        <td>
                                            <div class="flex items-center gap-3">
                                                <div class="avatar placeholder">
                                                    <div class="w-10 h-10 rounded-full bg-warning text-warning-content">
                                                        <span class="text-sm font-semibold">{{ exception.instructor.first_name[0] }}{{ exception.instructor.last_name[0] }}</span>
                                                    </div>
                                                </div>
                                                <div>
                                                    <p class="font-medium text-base-content">{{ exception.instructor.first_name }} {{ exception.instructor.last_name }}</p>
                                                    {% if exception.instructor.department %}
                                                    <p class="text-xs text-base-content/60">{{ exception.instructor.department }}</p>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-base-content/80">
                                            <div class="flex flex-col gap-1">
                                                <span class="font-medium">{{ exception.academic_year }}</span>
                                                <span class="text-xs text-base-content/60">{{ exception.semester }}{% if exception.semester == 1 %}st{% else %}nd{% endif %} Semester</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge badge-outline gap-1.5">
                                                {% if exception.grading_period == 'all' %}
                                                <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M3 3v18h18"/>
                                                    <path d="m19 9-5 5-4-4-3 3"/>
                                                </svg>
                                                All Periods
                                                {% elif exception.grading_period == 'prelim' %}
                                                <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <circle cx="12" cy="12" r="10"/>
                                                    <path d="M12 6v6l4 2"/>
                                                </svg>
                                                Prelim
                                                {% elif exception.grading_period == 'midterm' %}
                                                <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <circle cx="12" cy="12" r="10"/>
                                                    <path d="M12 6v6l4 2"/>
                                                </svg>
                                                Midterm
                                                {% else %}
                                                <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <circle cx="12" cy="12" r="10"/>
                                                    <path d="M12 6v6l4 2"/>
                                                </svg>
                                                Final
                                                {% endif %}
                                            </span>
                                        </td>
                                        <td class="text-base-content/70 text-sm">
                                            <div class="flex flex-col gap-0.5">
                                                <div class="flex items-center gap-1.5">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-base-content/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                                        <line x1="16" y1="2" x2="16" y2="6"/>
                                                        <line x1="8" y1="2" x2="8" y2="6"/>
                                                        <line x1="3" y1="10" x2="21" y2="10"/>
                                                    </svg>
                                                    <span class="font-medium">{{ exception.expiration_date.strftime('%b %d, %Y') }}</span>
                                                </div>
                                                <div class="flex items-center gap-1.5 text-xs text-base-content/50 ml-5">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <circle cx="12" cy="12" r="10"/>
                                                        <polyline points="12 6 12 12 16 14"/>
                                                    </svg>
                                                    {{ exception.expiration_date.strftime('%I:%M %p') }}
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-base-content/70 text-sm">
                                            {{ exception.granted_by_user.first_name }} {{ exception.granted_by_user.last_name }}
                                        </td>
                                        <td class="text-center">
                                            <button onclick="revokeAccess({{ exception.id }})" 
                                                    class="flex items-center justify-center gap-1 px-3 py-2 border-2 border-error text-error hover:bg-error hover:text-error-content rounded-lg transition-all duration-200 hover:shadow-md mx-auto"
                                                    title="Revoke access">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <circle cx="12" cy="12" r="10"/>
                                                    <line x1="15" y1="9" x2="9" y2="15"/>
                                                    <line x1="9" y1="9" x2="15" y2="15"/>
                                                </svg>
                                                <span class="text-sm font-medium">Revoke</span>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <!-- Empty State -->
                        <div class="text-center py-16">
                            <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-base-200 mb-6">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-base-content/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect width="18" height="11" x="3" y="11" rx="2" ry="2"/>
                                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                                </svg>
                            </div>
                            <h3 class="text-xl font-semibold text-base-content mb-2">No Active Access Grants</h3>
                            <p class="text-base-content/60 mb-6 max-w-md mx-auto">Grant access to instructors who need to encode grades after the schedule has been closed.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Recently Expired Exceptions -->
                {% if expired_exceptions %}
                <div class="bg-base-100 rounded-2xl border border-base-300/50 overflow-hidden shadow-sm mt-6">
                    <div class="p-6 border-b border-base-300/50">
                        <div class="flex items-center gap-3">
                            <div class="p-2.5 bg-base-200 rounded-xl">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-base-content/60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"/>
                                    <line x1="15" y1="9" x2="9" y2="15"/>
                                    <line x1="9" y1="9" x2="15" y2="15"/>
                                </svg>
                            </div>
                            <div>
                                <h4 class="text-lg font-semibold text-base-content">Recently Expired Access Grants</h4>
                                <p class="text-sm text-base-content/60">Automatically expired in the last 30 days</p>
                            </div>
                        </div>
                    </div>

                    <div class="p-6">
                        <div class="overflow-x-auto">
                            <table class="table w-full">
                                <thead>
                                    <tr class="border-base-300/50">
                                        <th class="bg-base-200/50 text-base-content/70 font-semibold">Instructor</th>
                                        <th class="bg-base-200/50 text-base-content/70 font-semibold">Academic Period</th>
                                        <th class="bg-base-200/50 text-base-content/70 font-semibold">Grading Period</th>
                                        <th class="bg-base-200/50 text-base-content/70 font-semibold">Expired On</th>
                                        <th class="bg-base-200/50 text-base-content/70 font-semibold">Granted By</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for exception in expired_exceptions %}
                                    <tr class="hover border-base-300/50 opacity-60">
                                        <td>
                                            <div class="flex items-center gap-3">
                                                <div class="avatar placeholder">
                                                    <div class="w-10 h-10 rounded-full bg-base-300 text-base-content">
                                                        <span class="text-sm font-semibold">{{ exception.instructor.first_name[0] }}{{ exception.instructor.last_name[0] }}</span>
                                                    </div>
                                                </div>
                                                <div>
                                                    <p class="font-medium text-base-content">{{ exception.instructor.first_name }} {{ exception.instructor.last_name }}</p>
                                                    {% if exception.instructor.department %}
                                                    <p class="text-xs text-base-content/60">{{ exception.instructor.department }}</p>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-base-content/80">
                                            <div class="flex flex-col gap-1">
                                                <span class="font-medium">{{ exception.academic_year }}</span>
                                                <span class="text-xs text-base-content/60">{{ exception.semester }}{% if exception.semester == 1 %}st{% else %}nd{% endif %} Semester</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge badge-ghost gap-1.5">
                                                {{ exception.grading_period|title }}
                                            </span>
                                        </td>
                                        <td class="text-base-content/70 text-sm">
                                            <div class="flex flex-col gap-0.5">
                                                <div class="flex items-center gap-1.5">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-base-content/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <circle cx="12" cy="12" r="10"/>
                                                        <line x1="15" y1="9" x2="9" y2="15"/>
                                                        <line x1="9" y1="9" x2="15" y2="15"/>
                                                    </svg>
                                                    <span class="font-medium">{{ (exception.revoked_at if exception.revoked_at else exception.expiration_date).strftime('%b %d, %Y') }}</span>
                                                </div>
                                                <div class="flex items-center gap-1.5 text-xs text-base-content/50 ml-5">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <circle cx="12" cy="12" r="10"/>
                                                        <polyline points="12 6 12 12 16 14"/>
                                                    </svg>
                                                    {{ (exception.revoked_at if exception.revoked_at else exception.expiration_date).strftime('%I:%M %p') }}
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-base-content/70 text-sm">
                                            {{ exception.granted_by_user.first_name }} {{ exception.granted_by_user.last_name }}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<script>
    // Real-time Schedule Status Checker
    let lastUpdateTimestamp = null;
    let checkInterval = null;

    function updateStatusIndicator(checking = false) {
        const indicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const mobileIndicator = document.getElementById('mobileStatusIndicator');
        const mobileStatusText = document.getElementById('mobileStatusText');
        
        if (indicator) {
            indicator.classList.remove('hidden');
            
            if (checking) {
                statusText.textContent = 'Checking...';
                indicator.classList.add('badge-info');
                indicator.classList.remove('badge-success');
                
                if (mobileStatusText) {
                    mobileStatusText.textContent = '';
                }
            } else {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                statusText.textContent = `Updated ${timeStr}`;
                indicator.classList.add('badge-success');
                indicator.classList.remove('badge-info');
                
                if (mobileStatusText) {
                    mobileStatusText.textContent = 'Live';
                }
            }
        }
    }

    async function checkScheduleUpdates() {
        try {
            updateStatusIndicator(true);
            
            const response = await fetch('/api/grade-encoding-schedule/check-updates');
            const data = await response.json();
            
            if (response.ok && data.status === 'success') {
                updateStatusIndicator(false);
                
                // Check if anything was updated
                if (data.updated) {
                    let message = '';
                    
                    if (data.schedules_updated) {
                        console.log(' Schedule statuses updated automatically');
                        message = 'Schedule statuses have been updated';
                    }
                    
                    if (data.exceptions_expired > 0) {
                        console.log(` ${data.exceptions_expired} encoding exception(s) expired automatically`);
                        if (message) {
                            message += ' and ';
                        }
                        message += `${data.exceptions_expired} access grant(s) expired`;
                    }
                    
                    showToast('info', message);
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                }
                lastUpdateTimestamp = data.timestamp;
            }
        } catch (error) {
            console.error('Error checking schedule updates:', error);
            updateStatusIndicator(false);
        }
    }

    // Start automatic checking when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Show initial status
        updateStatusIndicator(false);
        
        // Check immediately on page load
        checkScheduleUpdates();
        
        // Then check every 30 seconds
        checkInterval = setInterval(checkScheduleUpdates, 30000);
        
        console.log(' Real-time schedule monitoring activated (checks every 30 seconds)');
    });

    // Clean up interval when page is unloaded
    window.addEventListener('beforeunload', function() {
        if (checkInterval) {
            clearInterval(checkInterval);
        }
    });

    // Close Schedule Handler
    async function confirmClose(scheduleId) {
        try {
            const response = await fetch(`/api/grade-encoding-schedule/${scheduleId}/close`, {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showToast('success', 'Schedule closed successfully');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showToast('error', data.message || 'Error closing schedule');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('error', 'An error occurred while closing the schedule');
        }
    }

    // Edit Schedule Handler
    function editSchedule(id, academicYear, semester, gradingPeriod, status, department, startDate, endDate, startTime, endTime) {
        // Store data and trigger event
        const editData = {
            id: id,
            academic_year: academicYear,
            semester: parseInt(semester),
            grading_period: gradingPeriod,
            status: status,
            department: department || '',
            start_date: startDate,
            end_date: endDate,
            start_time: startTime || '',
            end_time: endTime || ''
        };
        
        // Dispatch custom event for Alpine.js to handle
        const event = new CustomEvent('edit-schedule', { 
            detail: editData 
        });
        document.dispatchEvent(event);
    }

    // Delete Schedule Handler
    async function confirmDelete(scheduleId) {
        try {
            const response = await fetch(`/api/grade-encoding-schedule/${scheduleId}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (response.ok) {
                location.reload();
            } else {
                showToast('error', data.message || 'Error deleting schedule');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('error', 'An error occurred while deleting the schedule');
        }
    }

    // Toast Notification System
    function showToast(type, message) {
        const toast = document.createElement('div');
        let alertClass = 'alert-success';
        if (type === 'error') alertClass = 'alert-error';
        else if (type === 'info') alertClass = 'alert-info';
        else if (type === 'warning') alertClass = 'alert-warning';
        
        toast.className = `alert fixed bottom-4 right-4 w-auto min-w-[20rem] max-w-md shadow-2xl z-[100] ${alertClass}`;
        
        let icon = '';
        if (type === 'success') {
            icon = `
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="m9 12 2 2 4-4"/>
                </svg>
            `;
        } else if (type === 'info') {
            icon = `
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="16" x2="12" y2="12"/>
                    <line x1="12" y1="8" x2="12.01" y2="8"/>
                </svg>
            `;
        } else {
            icon = `
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="15" y1="9" x2="9" y2="15"/>
                    <line x1="9" y1="9" x2="15" y2="15"/>
                </svg>
            `;
        }
        
        toast.innerHTML = `
            ${icon}
            <span class="flex-1">${message}</span>
            <button onclick="this.parentElement.remove()" class="btn btn-ghost btn-sm btn-circle">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        `;
        
        document.body.appendChild(toast);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            toast.remove();
        }, 5000);
    }

    // Handle Edit Form Submission
    document.addEventListener('DOMContentLoaded', function() {
        const editForm = document.getElementById('editScheduleForm');
        if (editForm) {
            editForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const scheduleId = formData.get('schedule_id');
                
                console.log('Submitting edit form for schedule ID:', scheduleId);
                
                // Prepare request data
                const requestData = {
                    academic_year: formData.get('academic_year'),
                    semester: parseInt(formData.get('semester')),
                    grading_period: formData.get('grading_period'),
                    status: formData.get('status'),
                    department: formData.get('department') || null,
                    start_date: formData.get('start_date'),
                    end_date: formData.get('end_date'),
                    start_time: formData.get('start_time') || null,
                    end_time: formData.get('end_time') || null
                };
                
                console.log('Request data:', requestData);
                console.log(' FRONTEND DEBUG - Values being sent:');
                console.log('   Academic Year:', requestData.academic_year);
                console.log('   Semester:', requestData.semester);
                console.log('   Grading Period:', requestData.grading_period);
                console.log('   Department:', requestData.department);
                console.log('   Start Date:', requestData.start_date);
                console.log('   End Date:', requestData.end_date);
                console.log('   Schedule ID:', scheduleId);
                
                // Debug: Show all existing schedules
                try {
                    const debugResponse = await fetch('/api/debug-schedules');
                    const debugData = await debugResponse.json();
                    console.log(' ALL EXISTING SCHEDULES:', debugData.schedules);
                } catch (debugError) {
                    console.error('Debug error:', debugError);
                }
                
                // Basic validation
                if (!requestData.academic_year || !requestData.semester || !requestData.grading_period || 
                    !requestData.status || !requestData.start_date || !requestData.end_date) {
                    showToast('error', 'Please fill in all required fields');
                    return;
                }
                
                if (requestData.start_date >= requestData.end_date) {
                    showToast('error', 'End date must be after start date');
                    return;
                }
                
                try {
                    const response = await fetch(`/api/grade-encoding-schedule/${scheduleId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    console.log('Response status:', response.status);
                    console.log('Response headers:', response.headers);
                    
                    const data = await response.json();
                    console.log('Response data:', data);
                    
                    if (response.ok) {
                        showToast('success', 'Schedule updated successfully');
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        // Show specific error message
                        const errorMessage = data.message || 'Error updating schedule';
                        showToast('error', errorMessage);
                        
                        // If it's a duplicate error, highlight the form
                        if (errorMessage.includes('already exists')) {
                            const form = document.getElementById('editScheduleForm');
                            form.classList.add('border-error', 'border-2');
                            setTimeout(() => {
                                form.classList.remove('border-error', 'border-2');
                            }, 3000);
                        }
                    }
                } catch (error) {
                    console.error('Network error:', error);
                    showToast('error', 'An error occurred while updating the schedule');
                }
            });
        }
    });

    // Handle Date Input Constraints
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date().toISOString().split('T')[0];
        const startDateInput = document.querySelector('input[name="start_date"]');
        const endDateInput = document.querySelector('input[name="end_date"]');
        
        if (startDateInput && endDateInput) {
            // Set minimum dates
            startDateInput.min = today;
            endDateInput.min = today;
            
            // Update end date minimum when start date changes
            startDateInput.addEventListener('change', function() {
                endDateInput.min = this.value;
                if (endDateInput.value && endDateInput.value < this.value) {
                    endDateInput.value = this.value;
                }
                
                // Auto-adjust status based on start date
                const statusSelect = document.querySelector('select[name="status"]');
                if (statusSelect && this.value === today) {
                    // If start date is today and status is upcoming, suggest active
                    if (statusSelect.value === 'upcoming') {
                        statusSelect.value = 'active';
                        console.log(' Auto-adjusting status to "active" since start date is today');
                    }
                }
            });
        }
        
        // Apply same constraints to edit modal date inputs
        const editStartDateInput = document.querySelector('#editScheduleForm input[name="start_date"]');
        const editEndDateInput = document.querySelector('#editScheduleForm input[name="end_date"]');
        
        if (editStartDateInput && editEndDateInput) {
            // Set minimum dates for edit modal
            editStartDateInput.min = today;
            editEndDateInput.min = today;
            
            // Update end date minimum when start date changes in edit modal
            editStartDateInput.addEventListener('change', function() {
                editEndDateInput.min = this.value;
                if (editEndDateInput.value && editEndDateInput.value < this.value) {
                    editEndDateInput.value = this.value;
                }
                
                // Auto-adjust status based on start date
                const statusSelect = document.querySelector('#editScheduleForm select[name="status"]');
                if (statusSelect && this.value === today) {
                    // If start date is today and status is upcoming, suggest active
                    if (statusSelect.value === 'upcoming') {
                        statusSelect.value = 'active';
                        console.log(' Auto-adjusting status to "active" since start date is today');
                    }
                }
            });
        }
        
        // Handle edit button clicks
        document.addEventListener('click', function(e) {
            if (e.target.closest('.edit-schedule-btn')) {
                const btn = e.target.closest('.edit-schedule-btn');
                const id = btn.dataset.scheduleId;
                const academicYear = btn.dataset.academicYear;
                const semester = btn.dataset.semester;
                const gradingPeriod = btn.dataset.gradingPeriod;
                const status = btn.dataset.status;
                const department = btn.dataset.department;
                const startDate = btn.dataset.startDate;
                const endDate = btn.dataset.endDate;
                const startTime = btn.dataset.startTime;
                const endTime = btn.dataset.endTime;
                
                editSchedule(id, academicYear, semester, gradingPeriod, status, department, startDate, endDate, startTime, endTime);
            }
        });
    });
    
    // Handle Grant Access Form Submission
    document.getElementById('grantAccessForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());
        
        // Validate: at least date or time must be provided
        const hasDate = data.expiration_date && data.expiration_date.trim();
        const hasTime = data.expiration_time && data.expiration_time.trim();
        
        if (!hasDate && !hasTime) {
            showToast('error', 'Please specify at least an expiration date or time');
            return;
        }
        
        try {
            const response = await fetch('/api/encoding-exception/grant', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                showToast('success', result.message || 'Access granted successfully');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showToast('error', result.message || 'Error granting access');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('error', 'An error occurred while granting access');
        }
    });
    
    // Revoke Access Function
    async function revokeAccess(exceptionId) {
        if (!confirm('Are you sure you want to revoke this access grant?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/encoding-exception/${exceptionId}/revoke`, {
                method: 'POST'
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                showToast('success', result.message || 'Access revoked successfully');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showToast('error', result.message || 'Error revoking access');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('error', 'An error occurred while revoking access');
        }
    }
    
    // Set minimum date for expiration
    document.addEventListener('DOMContentLoaded', function() {
        const expirationInput = document.querySelector('input[name="expiration_date"]');
        if (expirationInput) {
            const today = new Date().toISOString().split('T')[0];
            expirationInput.min = today;
        }
    });
</script>
{% endblock %}
