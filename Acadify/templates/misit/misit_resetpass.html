{% extends "common/base.html" %}

{% block title %}Reset User Password - Acadify{% endblock %}

{% block content %}
<section class="fade-in bg-base-100/50 min-h-[calc(100vh-4rem)] py-8">
    <div class="container max-w-[95rem] mx-auto px-4">
            <!-- Page Header -->
            <div class="flex justify-between items-center mb-8">
                <div class="flex items-center gap-3">
                    <div class="p-3 bg-warning/10 rounded-xl">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-warning" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M2 18v3c0 .6.4 1 1 1h4v-3h3v-3h2l1.4-1.4a6.5 6.5 0 1 0-4-4Z"/>
                            <circle cx="16.5" cy="7.5" r=".5"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-base-content">Reset User Password</h1>
                        <p class="text-base-content/60 mt-1">Manage and reset user account passwords</p>
                    </div>
                </div>
            </div>

            <!-- Alert Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} mb-6 shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                {% if category == 'success' %}
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                <polyline points="22 4 12 14.01 9 11.01"/>
                                {% elif category == 'error' or category == 'danger' %}
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="15" y1="9" x2="9" y2="15"/>
                                <line x1="9" y1="9" x2="15" y2="15"/>
                                {% else %}
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="16" x2="12" y2="12"/>
                                <line x1="12" y1="8" x2="12.01" y2="8"/>
                                {% endif %}
                            </svg>
                            <span>{{ message }}</span>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <!-- Search and Filter Section -->
            <div class="card bg-base-100 shadow-sm hover:shadow-md transition-all duration-300 rounded-xl border border-base-200 mb-6">
                <div class="card-body">
                    <div class="flex flex-wrap gap-4">
                        <div class="flex-1 relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-base-content/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"/>
                                    <path d="m21 21-4.3-4.3"/>
                                </svg>
                            </div>
                            <input type="text" 
                                   id="searchInput" 
                                   placeholder="Search by name, username, or email..."
                                   class="input input-bordered w-full pl-10 bg-base-100">
                        </div>
                        <div class="w-48">
                            <select id="roleFilter" class="select select-bordered w-full bg-base-100">
                                <option value="">All Roles</option>
                                <option value="student">Students</option>
                                <option value="instructor">Instructors</option>
                                <option value="registrar">Registrars</option>
                                <option value="dean">Deans</option>
                                <option value="mis_it">MIS/IT</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Table -->
            <div class="card bg-base-100 shadow-sm hover:shadow-md transition-all duration-300 rounded-xl border border-base-200 mb-6">
                <div class="card-body">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="p-2 bg-primary/10 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-semibold text-base-content">User Accounts</h2>
                            <p class="text-base-content/60 text-sm mt-1">Select a user to reset their password</p>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="table table-zebra w-full">
                            <thead>
                                <tr>
                                    <th class="text-base-content/70 font-medium">Name</th>
                                    <th class="text-base-content/70 font-medium">Username</th>
                                    <th class="text-base-content/70 font-medium">Email</th>
                                    <th class="text-base-content/70 font-medium">Role</th>
                                    <th class="text-base-content/70 font-medium">Department</th>
                                    <th class="text-base-content/70 font-medium text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                {% for user in users %}
                                {% if user.role != 'student' %}
                                <tr class="user-row hover" 
                                    data-name="{{ user.first_name }} {{ user.last_name }}"
                                    data-username="{{ user.username }}"
                                    data-email="{{ user.email }}"
                                    data-role="{{ user.role }}">
                                    <td class="font-medium">{{ user.first_name }} {{ user.last_name }}</td>
                                    <td>{{ user.username }}</td>
                                    <td>{{ user.email }}</td>
                                    <td>
                                        <div class="badge badge-lg gap-2
                                            {% if user.role == 'instructor' %}badge-success
                                            {% elif user.role == 'registrar' %}badge-warning
                                            {% elif user.role == 'dean' %}badge-primary
                                            {% else %}badge-secondary{% endif %}">
                                            {% if user.role == 'instructor' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                                                <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                                            </svg>
                                            {% elif user.role == 'registrar' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                                                <polyline points="14 2 14 8 20 8"/>
                                            </svg>
                                            {% elif user.role == 'dean' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M3 9h18v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9Z"/>
                                                <path d="m3 9 2.45-4.9A2 2 0 0 1 7.24 3h9.52a2 2 0 0 1 1.8 1.1L21 9"/>
                                                <path d="M12 3v6"/>
                                            </svg>
                                            {% else %}
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M20 7h-9"/>
                                                <path d="M14 17H5"/>
                                                <circle cx="17" cy="17" r="3"/>
                                                <circle cx="7" cy="7" r="3"/>
                                            </svg>
                                            {% endif %}
                                            {{ user.role|title }}
                                        </div>
                                    </td>
                                    <td>{{ user.department or '-' }}</td>
                                    <td class="text-right">
                                        <button onclick="openResetModal('{{ user.id }}', '{{ user.username }}')"
                                                class="flex items-center justify-center gap-1 px-3 py-2 border-2 border-warning text-warning hover:bg-warning hover:text-warning-content rounded-lg transition-all duration-200 hover:shadow-md"
                                                title="Reset password">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M2 18v3c0 .6.4 1 1 1h4v-3h3v-3h2l1.4-1.4a6.5 6.5 0 1 0-4-4Z"/>
                                                <circle cx="16.5" cy="7.5" r=".5"/>
                                            </svg>
                                            <span class="text-sm font-medium">Reset</span>
                                        </button>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Students Accounts Table -->
            <div class="card bg-base-100 shadow-sm hover:shadow-md transition-all duration-300 rounded-xl border border-base-200">
                <div class="card-body">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="p-2 bg-info/10 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-info" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 10v6M2 10l10-5 10 5-10 5z"/>
                                <path d="M6 12v5c3 3 9 3 12 0v-5"/>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-semibold text-base-content">Students Accounts</h2>
                            <p class="text-base-content/60 text-sm mt-1">Select a student to reset their password</p>
                            <!-- Debug info - remove in production -->
                            <div class="text-xs text-base-content/40 mt-1">
                                Staff users: {{ users|length }} | 
                                Students: {{ students|length }} |
                                Staff roles: {{ users|map(attribute='role')|unique|list|join(', ') }}
                            </div>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="table table-zebra w-full">
                            <thead>
                                <tr>
                                    <th class="text-base-content/70 font-medium">Name</th>
                                    <th class="text-base-content/70 font-medium">Username</th>
                                    <th class="text-base-content/70 font-medium">Email</th>
                                    <th class="text-base-content/70 font-medium">Student ID</th>
                                    <th class="text-base-content/70 font-medium">Course</th>
                                    <th class="text-base-content/70 font-medium text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody">
                                {% for student in students %}
                                <tr class="student-row hover" 
                                    data-name="{{ student.first_name }} {{ student.last_name }}"
                                    data-username="{{ student.username }}"
                                    data-email="{{ student.email }}"
                                    data-role="student">
                                    <td class="font-medium">{{ student.first_name }} {{ student.last_name }}</td>
                                    <td>{{ student.username }}</td>
                                    <td>{{ student.email }}</td>
                                    <td>
                                        <span class="badge badge-info gap-1.5">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                                <circle cx="9" cy="7" r="4"/>
                                            </svg>
                                            {{ student.student_id }}
                                        </span>
                                    </td>
                                    <td>{{ student.department or '-' }}</td>
                                    <td class="text-right">
                                        <div class="flex gap-2 justify-end">
                                            <button onclick="openResetModal('{{ student.id }}', '{{ student.username }}', 'student')"
                                                    class="flex items-center justify-center gap-1 px-3 py-2 border-2 border-warning text-warning hover:bg-warning hover:text-warning-content rounded-lg transition-all duration-200 hover:shadow-md"
                                                    title="Reset student password">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M2 18v3c0 .6.4 1 1 1h4v-3h3v-3h2l1.4-1.4a6.5 6.5 0 1 0-4-4Z"/>
                                                    <circle cx="16.5" cy="7.5" r=".5"/>
                                                </svg>
                                                <span class="text-sm font-medium">Reset</span>
                                            </button>
                                            <button onclick="openDeleteModal('{{ student.id }}', '{{ student.username }}', '{{ student.first_name }} {{ student.last_name }}')"
                                                    class="flex items-center justify-center gap-1 px-3 py-2 border-2 border-error text-error hover:bg-error hover:text-error-content rounded-lg transition-all duration-200 hover:shadow-md"
                                                    title="Delete student">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M3 6h18"/>
                                                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                                                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                                                </svg>
                                                <span class="text-sm font-medium">Remove</span>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                                
                                {% if students|length == 0 %}
                                <tr>
                                    <td colspan="6" class="text-center py-12">
                                        <div class="flex flex-col items-center gap-4">
                                            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-info/10">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-info" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M22 10v6M2 10l10-5 10 5-10 5z"/>
                                                    <path d="M6 12v5c3 3 9 3 12 0v-5"/>
                                                </svg>
                                            </div>
                                            <div>
                                                <h3 class="text-lg font-semibold text-base-content mb-2">No Student Accounts Found</h3>
                                                <p class="text-base-content/60 mb-4">There are currently no student accounts in the system.</p>
                                                <div class="text-sm text-base-content/50">
                                                    <p>Students will appear here once they are registered in the system.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
    </div>
</section>

<!-- Reset Password Modal -->
<div id="resetModal" class="fixed inset-0 bg-base-content/30 backdrop-blur-sm hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-0 w-[28rem] shadow-xl rounded-xl bg-base-100">
        <div class="px-6 py-4 border-b border-base-200">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-warning/10 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-warning" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M2 18v3c0 .6.4 1 1 1h4v-3h3v-3h2l1.4-1.4a6.5 6.5 0 1 0-4-4Z"/>
                        <circle cx="16.5" cy="7.5" r=".5"/>
                    </svg>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-base-content">Reset Password</h3>
                    <p class="text-base-content/60 text-sm">Set new password for <span id="resetUsername" class="font-medium"></span></p>
                </div>
            </div>
        </div>
        
        <form id="resetPasswordForm" class="p-6">
            <input type="hidden" id="userId" name="user_id">

            <div class="space-y-4">
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">New Password</span>
                    </label>
                    <div class="relative">
                        <input type="password" 
                               id="newPassword"
                               name="new_password" 
                               required
                               minlength="8"
                               class="input input-bordered w-full pr-10">
                        <div class="absolute inset-y-0 right-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-base-content/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                            </svg>
                        </div>
                    </div>
                    <label class="label">
                        <span class="label-text-alt text-base-content/60">Minimum 8 characters</span>
                    </label>
                </div>

                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Confirm Password</span>
                    </label>
                    <div class="relative">
                        <input type="password" 
                               id="confirmPassword"
                               required
                               class="input input-bordered w-full pr-10">
                        <div class="absolute inset-y-0 right-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-base-content/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-8 flex justify-end gap-3">
                <button type="button" 
                        onclick="closeResetModal()"
                        class="btn btn-ghost">
                    Cancel
                </button>
                <button type="submit"
                        class="btn btn-warning gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M2 18v3c0 .6.4 1 1 1h4v-3h3v-3h2l1.4-1.4a6.5 6.5 0 1 0-4-4Z"/>
                        <circle cx="16.5" cy="7.5" r=".5"/>
                    </svg>
                    Reset Password
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Student Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-base-content/30 backdrop-blur-sm hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-0 w-[28rem] shadow-xl rounded-xl bg-base-100">
        <div class="px-6 py-4 border-b border-base-200">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-error/10 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-error" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="15" y1="9" x2="9" y2="15"/>
                        <line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-base-content">Delete Student</h3>
                    <p class="text-base-content/60 text-sm">This action cannot be undone</p>
                </div>
            </div>
        </div>
        
        <div class="p-6">
            <div class="mb-6">
                <div class="alert alert-error bg-error/10 border-error/30">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-error" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    <span class="text-sm font-medium text-error">Are you sure you want to delete this student?</span>
                </div>
                <div class="mt-4 p-4 bg-base-200 rounded-lg">
                    <p class="text-base-content text-sm mb-2"><strong>Student:</strong> <span id="deleteStudentName" class="font-semibold"></span></p>
                    <p class="text-base-content/70 text-sm"><strong>Username:</strong> <span id="deleteStudentUsername" class="font-mono"></span></p>
                </div>
                <div class="mt-3 p-3 bg-warning/10 border border-warning/30 rounded-lg">
                    <p class="text-xs text-base-content/80">
                        <strong class="text-warning">Warning:</strong> This will permanently delete the student's account, including all related enrollments, grades, and records.
                    </p>
                </div>
            </div>

            <div class="flex justify-end gap-3">
                <button type="button" 
                        onclick="closeDeleteModal()"
                        class="btn btn-ghost">
                    Cancel
                </button>
                <button type="button"
                        onclick="confirmDelete()"
                        class="btn btn-error gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 6h18"/>
                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                    </svg>
                    Delete Student
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Toast Notification System
    function showToast(type, message) {
        const toast = document.createElement('div');
        toast.className = `alert fixed bottom-4 right-4 w-auto min-w-[20rem] max-w-[28rem] shadow-lg z-[100] ${
            type === 'success' ? 'alert-success' : 'alert-error'
        }`;
        
        const icon = type === 'success' ? `
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
        ` : `
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <line x1="15" y1="9" x2="9" y2="15"/>
                <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
        `;
        
        toast.innerHTML = `
            ${icon}
            <span class="flex-1">${message}</span>
            <button onclick="this.parentElement.remove()" class="btn btn-ghost btn-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        `;
        
        document.body.appendChild(toast);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            toast.classList.add('fade-out');
            setTimeout(() => toast.remove(), 300);
        }, 5000);
    }

    // Search and Filter Functionality with Debouncing
    const searchInput = document.getElementById('searchInput');
    const roleFilter = document.getElementById('roleFilter');
    const userRows = document.querySelectorAll('.user-row');
    const studentRows = document.querySelectorAll('.student-row');

    let searchTimeout;
    function filterUsers() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedRole = roleFilter.value.toLowerCase();

            // Filter user rows (staff only)
            userRows.forEach(row => {
                const name = row.dataset.name.toLowerCase();
                const username = row.dataset.username.toLowerCase();
                const email = row.dataset.email.toLowerCase();
                const role = row.dataset.role.toLowerCase();

                const matchesSearch = name.includes(searchTerm) || 
                                    username.includes(searchTerm) || 
                                    email.includes(searchTerm);
                const matchesRole = !selectedRole || role === selectedRole;

                row.style.display = matchesSearch && matchesRole ? '' : 'none';
            });

            // Filter student rows (students only)
            studentRows.forEach(row => {
                const name = row.dataset.name.toLowerCase();
                const username = row.dataset.username.toLowerCase();
                const email = row.dataset.email.toLowerCase();
                const role = row.dataset.role.toLowerCase();

                const matchesSearch = name.includes(searchTerm) || 
                                    username.includes(searchTerm) || 
                                    email.includes(searchTerm);
                const matchesRole = !selectedRole || role === selectedRole;

                row.style.display = matchesSearch && matchesRole ? '' : 'none';
            });
        }, 150); // Debounce delay
    }

    searchInput.addEventListener('input', filterUsers);
    roleFilter.addEventListener('change', filterUsers);

    // Password Reset Modal Functionality with Enhanced Validation
    const resetModal = document.getElementById('resetModal');
    const resetForm = document.getElementById('resetPasswordForm');
    const userIdInput = document.getElementById('userId');
    const resetUsernameSpan = document.getElementById('resetUsername');
    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');

    function openResetModal(userId, username, userType = 'user') {
        userIdInput.value = userId;
        resetUsernameSpan.textContent = username;
        resetForm.reset();
        resetModal.classList.remove('hidden');
        
        // Add visual indicator for student reset
        if (userType === 'student') {
            resetUsernameSpan.innerHTML = `${username} <span class="badge badge-info badge-sm ml-2">Student</span>`;
        } else {
            resetUsernameSpan.textContent = username;
        }
        
        setTimeout(() => newPasswordInput.focus(), 100);
    }

    function closeResetModal() {
        resetModal.classList.add('hidden');
        resetForm.reset();
    }

    // Password validation
    function validatePassword() {
        const password = newPasswordInput.value;
        const confirm = confirmPasswordInput.value;

        if (password.length < 8) {
            showToast('error', 'Password must be at least 8 characters long');
            return false;
        }

        if (password !== confirm) {
            showToast('error', 'Passwords do not match');
            return false;
        }

        return true;
    }

    resetForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        if (!validatePassword()) {
            return;
        }

        try {
            const response = await fetch('/api/reset-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    user_id: userIdInput.value,
                    new_password: newPasswordInput.value
                })
            });

            const data = await response.json();

            if (response.ok) {
                const userType = resetUsernameSpan.innerHTML.includes('Student') ? 'student' : 'user';
                const successMessage = userType === 'student' 
                    ? 'Student password reset successfully' 
                    : 'Password reset successfully';
                showToast('success', data.message || successMessage);
                closeResetModal();
            } else {
                showToast('error', data.message || 'Error resetting password');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('error', 'An error occurred while resetting the password');
        }
    });

    // Close modal when clicking outside
    window.onclick = function(event) {
        if (event.target == resetModal) {
            closeResetModal();
        }
        if (event.target == deleteModal) {
            closeDeleteModal();
        }
    };

    // Delete Student Modal Functionality
    const deleteModal = document.getElementById('deleteModal');
    const deleteStudentName = document.getElementById('deleteStudentName');
    const deleteStudentUsername = document.getElementById('deleteStudentUsername');
    let currentDeleteStudentId = null;
    let currentDeleteUsername = null;
    let currentDeleteName = null;

    function openDeleteModal(studentId, username, name) {
        currentDeleteStudentId = studentId;
        currentDeleteUsername = username;
        currentDeleteName = name;
        deleteStudentName.textContent = name;
        deleteStudentUsername.textContent = username;
        deleteModal.classList.remove('hidden');
    }

    function closeDeleteModal() {
        deleteModal.classList.add('hidden');
        currentDeleteStudentId = null;
        currentDeleteUsername = null;
        currentDeleteName = null;
    }

    async function confirmDelete() {
        if (!currentDeleteStudentId) {
            showToast('error', 'No student selected');
            return;
        }

        try {
            const response = await fetch('/api/delete-student', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    student_id: currentDeleteStudentId
                })
            });

            const data = await response.json();

            if (response.ok) {
                showToast('success', data.message || 'Student deleted successfully');
                closeDeleteModal();
                // Reload the page to reflect the changes
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showToast('error', data.message || 'Error deleting student');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('error', 'An error occurred while deleting the student');
        }
    }
</script>
{% endblock %}