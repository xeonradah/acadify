{% extends "common/base.html" %}

{% block title %}Manual Grade Entry - {{ academic_year }} - Acadify{% endblock %}

{% block content %}
<section class="min-h-screen py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center gap-4">
                <div class="p-3 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11 4H4a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-base-content tracking-tight">Manual Grade Entry</h1>
                    <p class="text-base-content/60 mt-1">Enter historical grades manually for {{ academic_year or 'selected academic year' }}</p>
                </div>
            </div>
        </div>

        {% if not academic_year %}
        <!-- Academic Year Selection -->
        <div class="card bg-base-100 shadow-xl mb-8">
            <div class="card-body">
                <h2 class="card-title mb-4">Select Academic Year</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <a href="?academic_year=2023-2024" class="btn btn-outline btn-lg">
                        <div class="text-center">
                            <div class="text-lg font-bold">2023-2024</div>
                            <div class="text-sm opacity-60">Current Year</div>
                        </div>
                    </a>
                    <a href="?academic_year=2022-2023" class="btn btn-outline btn-lg">
                        <div class="text-center">
                            <div class="text-lg font-bold">2022-2023</div>
                            <div class="text-sm opacity-60">Previous Year</div>
                        </div>
                    </a>
                    <a href="?academic_year=2021-2022" class="btn btn-outline btn-lg">
                        <div class="text-center">
                            <div class="text-lg font-bold">2021-2022</div>
                            <div class="text-sm opacity-60">Historical</div>
                        </div>
                    </a>
                    <a href="?academic_year=2020-2021" class="btn btn-outline btn-lg">
                        <div class="text-center">
                            <div class="text-lg font-bold">2020-2021</div>
                            <div class="text-sm opacity-60">Historical</div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Grade Entry Form -->
        <div class="card bg-base-100 shadow-xl mb-8">
            <div class="card-body">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-primary/10 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-semibold">Grade Entry Form</h2>
                            <p class="text-sm text-base-content/60">{{ academic_year }} - {{ semester }}{% if semester == '1' %}st{% else %}nd{% endif %} Semester</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <select class="select select-bordered" id="semesterSelect" onchange="changeSemester()">
                            <option value="1" {% if semester == '1' %}selected{% endif %}>1st Semester</option>
                            <option value="2" {% if semester == '2' %}selected{% endif %}>2nd Semester</option>
                        </select>
                        <button class="btn btn-outline" onclick="window.close()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                            Close
                        </button>
                    </div>
                </div>

                {% if students and subjects %}
                <!-- Grade Entry Table -->
                <div class="overflow-x-auto">
                    <table class="table table-zebra w-full">
                        <thead>
                            <tr class="bg-base-200">
                                <th>Student</th>
                                <th>Subject</th>
                                <th class="text-center">Prelim</th>
                                <th class="text-center">Midterm</th>
                                <th class="text-center">Final</th>
                                <th class="text-center">Average</th>
                                <th class="text-center">Equivalent</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                                {% for subject in subjects %}
                                <tr class="grade-entry-row" data-student-id="{{ student.id }}" data-subject-id="{{ subject.id }}">
                                    <td>
                                        <div class="flex items-center gap-3">
                                            <div class="avatar placeholder">
                                                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 text-white">
                                                    <span class="text-xs font-bold">{{ student.first_name[0] }}{{ student.last_name[0] }}</span>
                                                </div>
                                            </div>
                                            <div>
                                                <div class="font-medium">{{ student.student_id }}</div>
                                                <div class="text-sm opacity-60">{{ student.last_name }}, {{ student.first_name }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <div class="font-medium">{{ subject.subject_code }}</div>
                                            <div class="text-sm opacity-60">{{ subject.subject_name }}</div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <input type="number" 
                                               class="input input-sm w-20 text-center grade-input" 
                                               min="0" max="100" step="0.01"
                                               placeholder="0.00"
                                               data-grade-type="prelim">
                                    </td>
                                    <td class="text-center">
                                        <input type="number" 
                                               class="input input-sm w-20 text-center grade-input" 
                                               min="0" max="100" step="0.01"
                                               placeholder="0.00"
                                               data-grade-type="midterm">
                                    </td>
                                    <td class="text-center">
                                        <input type="number" 
                                               class="input input-sm w-20 text-center grade-input" 
                                               min="0" max="100" step="0.01"
                                               placeholder="0.00"
                                               data-grade-type="final">
                                    </td>
                                    <td class="text-center">
                                        <span class="final-average font-bold text-lg">—</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="equivalent-grade font-bold text-lg">—</span>
                                    </td>
                                    <td class="text-center">
                                        <button class="btn btn-primary btn-sm" onclick="saveGrade(this)">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                                                <polyline points="17 21 17 13 7 13 7 21"/>
                                                <polyline points="7 3 7 8 15 8"/>
                                            </svg>
                                            Save
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Bulk Actions -->
                <div class="flex justify-between items-center mt-6 pt-6 border-t border-base-300">
                    <div class="text-sm text-base-content/60">
                        Total: {{ students|length }} students × {{ subjects|length }} subjects = {{ students|length * subjects|length }} grade entries
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-outline" onclick="clearAllGrades()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 6h18"/>
                                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                            </svg>
                            Clear All
                        </button>
                        <button class="btn btn-primary" onclick="saveAllGrades()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                                <polyline points="17 21 17 13 7 13 7 21"/>
                                <polyline points="7 3 7 8 15 8"/>
                            </svg>
                            Save All Grades
                        </button>
                    </div>
                </div>
                {% else %}
                <!-- Empty State -->
                <div class="text-center py-12">
                    <div class="p-4 bg-base-200 rounded-full w-fit mx-auto mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 opacity-60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold mb-2">No Data Available</h3>
                    <p class="opacity-60 mb-4">
                        {% if not students %}
                            No students found for academic year {{ academic_year }}.
                        {% elif not subjects %}
                            No subjects found for {{ academic_year }} - {{ semester }}{% if semester == '1' %}st{% else %}nd{% endif %} Semester.
                        {% endif %}
                    </p>
                    <button class="btn btn-outline" onclick="window.close()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                        Close
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</section>

<script>
// Grade calculation constants
const GRADE_SCALES = [
    { min: 98, equivalent: 1.00, remarks: "Passed" },
    { min: 95, equivalent: 1.25, remarks: "Passed" },
    { min: 92, equivalent: 1.50, remarks: "Passed" },
    { min: 89, equivalent: 1.75, remarks: "Passed" },
    { min: 86, equivalent: 2.00, remarks: "Passed" },
    { min: 83, equivalent: 2.25, remarks: "Passed" },
    { min: 80, equivalent: 2.50, remarks: "Passed" },
    { min: 77, equivalent: 2.75, remarks: "Passed" },
    { min: 75, equivalent: 3.00, remarks: "Passed" },
    { min: 0,  equivalent: 5.00, remarks: "Failed" }
];

function calculateGradeEquivalent(average) {
    const scale = GRADE_SCALES.find(scale => average >= scale.min);
    return scale ? [scale.equivalent, scale.remarks] : [5.00, "Failed"];
}

function calculateAverage(row) {
    const inputs = row.querySelectorAll('.grade-input');
    const grades = Array.from(inputs).map(input => parseFloat(input.value));
    
    if (grades.every(grade => !isNaN(grade))) {
        const average = grades.reduce((a, b) => a + b, 0) / grades.length;
        const roundedAverage = Math.round(average * 100) / 100;
        const [equivalent, remarks] = calculateGradeEquivalent(roundedAverage);
        
        const averageElement = row.querySelector('.final-average');
        const equivalentElement = row.querySelector('.equivalent-grade');
        
        averageElement.textContent = roundedAverage.toFixed(2);
        equivalentElement.textContent = equivalent.toFixed(2);
        
        // Color coding
        if (equivalent <= 3.00) {
            averageElement.className = 'final-average font-bold text-lg text-success';
            equivalentElement.className = 'equivalent-grade font-bold text-lg text-success';
        } else {
            averageElement.className = 'final-average font-bold text-lg text-error';
            equivalentElement.className = 'equivalent-grade font-bold text-lg text-error';
        }
    } else {
        row.querySelector('.final-average').textContent = '—';
        row.querySelector('.equivalent-grade').textContent = '—';
        row.querySelector('.final-average').className = 'final-average font-bold text-lg';
        row.querySelector('.equivalent-grade').className = 'equivalent-grade font-bold text-lg';
    }
}

function changeSemester() {
    const semester = document.getElementById('semesterSelect').value;
    const url = new URL(window.location);
    url.searchParams.set('semester', semester);
    window.location.href = url.toString();
}

function saveGrade(button) {
    const row = button.closest('tr');
    const studentId = row.dataset.studentId;
    const subjectId = row.dataset.subjectId;
    
    const inputs = row.querySelectorAll('.grade-input');
    const prelim = inputs[0].value || null;
    const midterm = inputs[1].value || null;
    const final = inputs[2].value || null;
    
    if (!prelim && !midterm && !final) {
        alert('Please enter at least one grade');
        return;
    }
    
    // Show loading state
    const originalText = button.innerHTML;
    button.innerHTML = 'Saving...';
    button.disabled = true;
    
    const gradeData = {
        student_id: studentId,
        subject_id: subjectId,
        semester: {{ semester }},
        academic_year: '{{ academic_year }}',
        prelim_grade: prelim ? parseFloat(prelim) : null,
        midterm_grade: midterm ? parseFloat(midterm) : null,
        final_grade: final ? parseFloat(final) : null
    };
    
    fetch('/api/save-historical-grade', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(gradeData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Grade saved successfully!');
            button.innerHTML = 'Saved';
            button.classList.remove('btn-primary');
            button.classList.add('btn-success');
        } else {
            alert('Error: ' + data.message);
            button.innerHTML = originalText;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Save failed: ' + error.message);
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function saveAllGrades() {
    const rows = document.querySelectorAll('.grade-entry-row');
    let savedCount = 0;
    let totalCount = 0;
    
    rows.forEach(row => {
        const inputs = row.querySelectorAll('.grade-input');
        const hasGrades = Array.from(inputs).some(input => input.value.trim() !== '');
        
        if (hasGrades) {
            totalCount++;
            const button = row.querySelector('button[onclick="saveGrade(this)"]');
            if (!button.disabled) {
                saveGrade(button);
                savedCount++;
            }
        }
    });
    
    if (totalCount === 0) {
        alert('No grades to save');
    } else {
        alert(`Saving ${savedCount} grade entries...`);
    }
}

function clearAllGrades() {
    if (confirm('Are you sure you want to clear all grades?')) {
        document.querySelectorAll('.grade-input').forEach(input => {
            input.value = '';
        });
        document.querySelectorAll('.final-average').forEach(el => {
            el.textContent = '—';
            el.className = 'final-average font-bold text-lg';
        });
        document.querySelectorAll('.equivalent-grade').forEach(el => {
            el.textContent = '—';
            el.className = 'equivalent-grade font-bold text-lg';
        });
    }
}

// Initialize event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Add change listeners to grade inputs
    document.querySelectorAll('.grade-input').forEach(input => {
        input.addEventListener('input', function() {
            calculateAverage(this.closest('tr'));
        });
    });
});
</script>
{% endblock %}
